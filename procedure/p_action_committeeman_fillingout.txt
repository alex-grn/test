CREATE OR REPLACE FUNCTION public.p_action_committeeman_fillingout (
  idlist text
)
RETURNS void AS
$body$
declare
  NID_AGENTACC BIGINT;
  REC          record;
  GEN_TEXT     TEXT := '@';
begin
  for REC in (select S.ID, S.PERSONID
                from ELECTCOMMITTEE X, COMMITTEEMAN S
               where S.ELECTCOMMITTEEID = X.ID
                 and X.ID = any(P_SYSTEM_GET_SELECTLIST(IDLIST)))
  loop
    begin
      select S.ID
        into STRICT NID_AGENTACC
        from PERSONACC S
       where S.PERSONID = REC.PERSONID
         and NOW() >= S.BEGINDATE
         and (NOW() <= S.ENDDATE or S.ENDDATE is null);
    exception
      when NO_DATA_FOUND then
        GEN_TEXT = (
          select P.code from PERSON P where P.ID = REC.PERSONID) || ';' || CHR(13);
    end;
    update COMMITTEEMAN S
       set TRPERSONID  = PERSONID,
           PERSONACCID = NID_AGENTACC
     where S.ID = REC.ID;
  end loop;
  if GEN_TEXT <> '@'
  then
    GEN_TEXT = 'Не задан действующий лицевой счёт для: ' || GEN_TEXT || '. Введите данные о лицевом счете в словаре Физические лица.';
    raise
      using MESSAGE = GEN_TEXT;
  end if;
end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_committeeman_fillingout (idlist text)
  OWNER TO magicbox;
 CREATE  OR  REPLACE  FUNCTION  public.p_action_electcommincamp_dot_chair(id  bigint,  begindate  date,  enddate  date)
  RETURNS  void
  LANGUAGE  plpgsql
AS  $function$
/*Действие:  Сформировать  ведомость  на  ДОТ  за  активную  работу  председателям  УИК*/
declare
    CAMPID  BIGINT  :=  ID;
    BDATE    date  :=  BEGINDATE;  --неоднозначная  ссылка
    EDATE    date  :=  ENDDATE;  --неоднозначная  ссылка
    REC        record;
    IZ          record;
    RK          record;
    STEMP    TEXT;
    NID        BIGINT;
    COMPIT  TEXT  :=  'Компенсация';  --таблица  pays  всегда  компенсация
    COMID    BIGINT;
    REGID    BIGINT;
    TDOC      BIGINT;
    TIK        TEXT  :=  'territory';  --код  ТИК  в  системе
    IKMO      TEXT  :=  'circuit';  --код  ИКМО
begin
    for  REC  in  (select  S.*,
                                          IK.LEVELELCOMMITTEE  as  level
                                from  ELECTCOMMINCAMP  S,
                                          ELECTCOMMITTEE    IK
                              where  S.ID  =  CAMPID
                                  and  IK.ID  =  S.ELECTCOMMITTEEID)
    loop
        
        if  REC.LEVEL  !=  TIK  AND  REC.LEVEL  !=  IKMO  then
            raise
                using  MESSAGE  =  'Документ  формируется  только  для  ТИК!';
        end  if;
        
        select  S.ID  into  TDOC  from  DOCTYPES  S  where  LOWER(S.CODE)  =  'ведомость  дот  за  активную  работу  председателям  уик';
    
        /*    
            Не  создан  ли  такой  документ.  Проверку  надо  поводить  по  типу  документа  и  периоду  работы  комиссии
        */
        if  (select  count(*)
                    from  REGISTER  R
                  where  R.ELECTCOMMINCAMPID  =  REC.ID
                      and  R.DOCTYPEID  =  TDOC)  >  0  then
            raise
                using  MESSAGE  =  'Документ  уже  существует!';
        end  if;
    
        STEMP  :=  TDOC  ||  '_'  ||  --Код  избирательного  участка
                          (select  COALESCE(TO_CHAR(X.ELECTDATE,  'dd.mm.yyyy'),  '')  from  ELECTCAMPAIGN  X  where  X.ID  =  REC.ELECTCAMPAIGNID)  ||  '_';  --Дата  выборов
        update  ELECTCOMMINCAMP  S  set  MSREGISTER  =  COALESCE(MSREGISTER,  0)  +  1  where  S.ID  =  REC.ID;  --апдейтим  КОД
        insert  into  REGISTER
            (CODE,  DOCTYPEID,  STATUS,  ELECTCAMPAIGNID,  BEGINDATE,  ENDDATE,  ELECTCOMMINCAMPID,  DATELOADTBL,  RESPONSPERSID)
            select  STEMP,
                          TDOC,
                          1,
                          REC.ELECTCAMPAIGNID,
                          BDATE,
                          EDATE,
                          REC.ID,
                          null,
                          null  
      returning  REGISTER.ID
                into  REGID;
        update  REGISTER  S  set  CODE  =  S.CODE  ||  S.ID  where  S.ID  =  REGID;
        
        for  IZ  in  (select  R.CODE,
                                            R.ID,
                                            R.POSTSID,
                                            R.PERSONID,
                                            --D.LEVELELCOMMITTEE,
                                            (SELECT  RS.LEVELDCCHAIRMAN  FROM  ELECTCOMMINCAMP  K,  REGISTER  RR,  REGISTERLIST  RS  WHERE  K.ELECTCOMMITTEEID  =  IK.ID  AND  RR.ELECTCOMMINCAMPID  =  K.ID  AND  RS.REGISTERID  =  RR.ID  AND  RS.COMMITTEEMANID  =  R.ID  LIMIT  1)  AS  LEVELELCOMMITTEE
                                  from  ELECTCOMMITTEE  X,
                                            ELECTCOMMITTEE  IK,
                                            COMMITTEEMAN      R,
                                            POSTS                    D
                                where  X.ID  =  REC.ELECTCOMMITTEEID
                                    and  IK.IDGASPARECOM  =  X.IDGASECOM
                                    and  R.ELECTCOMMITTEEID  =  IK.ID
                                    and  IK.ID  in  (select  S.ELECTCOMMITTEEID  from  ELECTCOMMINCAMP  S  where  S.ELECTCAMPAIGNID  =  REC.ELECTCAMPAIGNID)
                                    and  D.ID  =  R.POSTSID
                                    and  (BDATE  between  R.POSTBEGINDATE  and  R.POSTENDDATE  or  EDATE  between  R.POSTBEGINDATE  and  R.POSTENDDATE  or  R.POSTBEGINDATE  between  BDATE  and  EDATE  or  R.POSTENDDATE  between  BDATE  and  EDATE)
                                    and  D.LEVELELCOMMITTEE  =  'district'  --УИК
                                    and  UPPER(D.POSTPRINT)  =  'CHAIRMAN')
        loop
            --Проверка  на  уровень
            if  exists  (select  1
                        from  ELECTCOMMINCAMP  S,
                                  REGISTER                R,
                                  DOCTYPES                T,
                                  REGISTERLIST        RS
                      where  S.ELECTCAMPAIGNID  =  REC.ELECTCAMPAIGNID
                          and  R.ELECTCOMMINCAMPID  =  S.ID
                          and  T.ID  =  R.DOCTYPEID
                          and  LOWER(T.CODE)  =  'комплект  расчетных  форм'
                          and  RS.COMMITTEEMANID  =  IZ.ID
                          and  RS.LEVELDCCHAIRMAN  =  'district'  --УИК
                          and  RS.REGISTERID  =  R.ID)  then
                continue;
            end  if;
            --
            insert  into  REGISTERLIST
                (REGISTERID,  CODE,  COMMITTEEMANID,  MIDDLESALARY,  DEPCOEFF,  LEVELDCCHAIRMAN  /*,  WHCOMP,  WHEXTRAFULL,  WHEXTRANIGHT,  WHEXTRAHOL,  WHEXTRAWORKDAY*/)
                select  REGID,
                              IZ.CODE,
                              IZ.ID,
                              0,
                              0,
                              IZ.LEVELELCOMMITTEE
          returning  REGISTERLIST.ID
                    into  NID;
        
            select  S.ID  into  COMID  from  SLCOMPCHARGES  S  where  UPPER(trim(S.DESCRIPTION))  =  LOWER('EXTRAA');
            insert  into  PAYS  (REGISTERLISTID,  SLCOMPCHARGESID)  values  (NID,  COMID);
            select  S.ID  into  COMID  from  SLCOMPCHARGES  S  where  UPPER(trim(S.DESCRIPTION))  =  LOWER('SUMALL');
            insert  into  PAYS  (REGISTERLISTID,  SLCOMPCHARGESID)  values  (NID,  COMID);
        end  loop;
    end  loop;
end;
$function$
 

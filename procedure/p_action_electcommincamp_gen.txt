CREATE OR REPLACE FUNCTION public.p_action_electcommincamp_gen (
  begindate date,
  enddate date,
  leveldcchairman text,
  ncount integer,
  idlist text
)
RETURNS void AS
$body$
declare
  BDATE date := BEGINDATE; --неоднозначная ссылка
  EDATE date := ENDDATE; --неоднозначная ссылка
  --LVLCOM TEXT := UPPER(LEVELELCOMMITTEE); --неоднозначная ссылка //убрали параметр levelelcommittee по событию 3829
  REC    record;
  IZ     record;
  RK     record;
  STEMP  TEXT;
  NID    BIGINT;
  COMPIT TEXT := 'Компенсация'; --таблица pays всегда компенсация
  COMID  BIGINT;
  REGID  BIGINT;
  SUBID  BIGINT; --ID субъекта РФ
  TDOC   BIGINT;
  TIK    TEXT := 'territory'; --код ТИК в системе
begin
  select R.ID into SUBID from REGIONSRF R where R.NAME = 'Российская Федерация';

  for REC in (select S.*, I.BEGINDATE, I.ENDDATE, I.BEGINDATETER, I.ENDDATETER, UPPER(I.LEVELELCAMPAIGN) as level, IK.REGIONSRFID as REGION
                from ELECTCOMMINCAMP S, ELECTCAMPAIGN I, ELECTCOMMITTEE IK
               where S.ID = any(P_SYSTEM_GET_SELECTLIST(IDLIST))
                 and I.ID = S.ELECTCAMPAIGNID
                 and IK.ID = S.ELECTCOMMITTEEID)
  loop
    select S.ID into TDOC from DOCTYPES S where S.CODE = 'Комплект расчетных форм';
    --Проверки
    if (select count(*)
          from REGISTER S
         where S.ELECTCOMMINCAMPID = REC.ID and S.DOCTYPEID = TDOC
           and (BDATE between S.BEGINDATE and S.ENDDATE or EDATE between S.BEGINDATE and S.ENDDATE)) > 0
    then
      raise
        using MESSAGE = 'На периоде ' || TO_CHAR(BDATE, 'dd.mm.yyyy') || ' - ' || TO_CHAR(EDATE, 'dd.mm.yyyy') || ' сформирован комплект расчетных форм!';
    end if;
    if REC.LEVELELCOMMITTEE = TIK
    then
      if REC.BEGINDATETER > BDATE or REC.BEGINDATETER > EDATE or REC.ENDDATETER < BDATE or REC.ENDDATETER < EDATE
      then
        raise
          using MESSAGE = 'Неверно указан период работы членов избирательной комиссии. Для избирательной кампании период работы членов установлен c ' || TO_CHAR(REC.BEGINDATETER, 'dd.mm.yyyy') || ' по ' || TO_CHAR(REC.ENDDATETER,
                                                                                                                                                                                                                      'dd.mm.yyyy');
      elsif REC.BEGINDATETER is null or REC.ENDDATETER is null
      then
        raise
          using MESSAGE = 'Не задан период работы ТИК в избирательных кампаниях!';
      end if;
    else
      if REC.BEGINDATE > BDATE or REC.BEGINDATE > EDATE or REC.ENDDATE < BDATE or REC.ENDDATE < EDATE
      then
        raise
          using MESSAGE = 'Неверно указан период работы членов избирательной комиссии. Для избирательной кампании период работы членов установлен c ' || TO_CHAR(REC.BEGINDATE, 'dd.mm.yyyy') || ' по ' || TO_CHAR(REC.ENDDATE,
                                                                                                                                                                                                                   'dd.mm.yyyy');
      end if;
    end if;
    --
    -- continue when UPPER(REC.LEVELELCOMMITTEE) != LVLCOM; --raise using message = '@'||upper(rec.levelelcommittee) ||'='|| lvlcom||'@';  //убрали параметр levelelcommittee по событию 3829
    
    STEMP := TDOC || '_' || --Код избирательного участка
             (select COALESCE(TO_CHAR(X.ELECTDATE, 'dd.mm.yyyy'), '') from ELECTCAMPAIGN X where X.ID = REC.ELECTCAMPAIGNID) || '_';
    update ELECTCOMMINCAMP S set MSREGISTER = COALESCE(MSREGISTER, 0) + 1 where S.ID = REC.ID; --апдейтим КОД
  
    insert into REGISTER
      (CODE, DOCTYPEID, STATUS, ELECTCAMPAIGNID, BEGINDATE, ENDDATE, ELECTCOMMINCAMPID, /* ELECDISTNUMB,*/ DATELOADTBL, RESPONSPERSID /*, LEVELELCOMMITTEE ,indicationcircuit,indicationship*/)
      select STEMP, TDOC, 1, REC.ELECTCAMPAIGNID, BDATE, EDATE, REC.ID, /* X.ELECDISTNUMB,*/ null, null /*, LVLCOM ,x.INDICATIONCIRCUIT,x.INDICATIONSHIP*/ returning ID into REGID;
    update REGISTER S set CODE = CODE || REGID where S.ID = REGID;
    for IZ in (select R.CODE,
                      R.ID,
                      R.POSTSID,
                      R.PERSONID,
                      case
                        when '@' || D.NAME || '@' ILIKE '%председатель%' then
                         LEVELDCCHAIRMAN
                      /* else
                      'district'*/
                      end as LVLCH
                 from ELECTCOMMITTEE X, COMMITTEEMAN R, POSTS D
                where X.ID = REC.ELECTCOMMITTEEID
                  and R.ELECTCOMMITTEEID = X.ID
                  and D.ID = R.POSTSID
                  and ((BDATE between R.POSTBEGINDATE and R.POSTENDDATE or EDATE between R.POSTBEGINDATE and R.POSTENDDATE)
                  		or (BDATE between R.POSTBEGINDATE and R.POSTENDDATE and EDATE between R.POSTBEGINDATE and R.POSTENDDATE)
                        or (R.POSTBEGINDATE between BDATE and EDATE and R.POSTENDDATE between BDATE and EDATE))
               )
    loop
      --Наполняем таблицу "члены избирательных комиссий"
      insert into REGISTERLIST
        (REGISTERID, CODE, COMMITTEEMANID, MIDDLESALARY, DEPCOEFF, LEVELDCCHAIRMAN /*, WHCOMP, WHEXTRAFULL, WHEXTRANIGHT, WHEXTRAHOL, WHEXTRAWORKDAY*/)
        select REGID,
               IZ.CODE,
               IZ.ID,
               (select P.VALUE
                  from PERSON S, PERSONSAVSLR P
                 where S.ID = IZ.PERSONID
                   and P.PERSONID = S.ID
                   and P.ELECTCAMPAIGNID = REC.ELECTCAMPAIGNID),
               0,
               IZ.LVLCH /*,
                                                         0,
                                                         0,
                                                         0,
                                                         0,
                                                         0*/ returning ID
          into NID;
      if (select S.LEVELELCAMPAIGN from ELECTCAMPAIGN S where S.ID = REC.ELECTCAMPAIGNID) = 'central'
      then
        --Уровень федеральный 
        for RK in (select DD, --заполняем таблицу worktbl 
                          (select D.TYPEDAYID
                             from WORKCALENDARS W, DAYSWORKCALENDARS D
                            where D.WORKCALENDARSID = W.ID
                              and W.REGIONSRFID = SUBID --Российская Федерация
                              and D.DATEWC = DD) as STYPE
                     from GENERATE_SERIES(BDATE, EDATE, interval '1 day') as DD)
        loop
          for I in 1 .. NCOUNT
          loop
            insert into WORKTBL (REGISTERLISTID, DATETBL, TYPEDAYID) values (NID, RK.DD, RK.STYPE);
          end loop;
        end loop;
        for RK in (select (
                         select W.ID
                           from WORKCALENDARS W
                          where W.REGIONSRFID = SUBID
                            and W.MONTH ::integer = TO_CHAR(DD, 'mm') ::integer) as WID
                   from GENERATE_SERIES(BDATE, EDATE, interval '1 month') as DD)
       loop
        select S.ID into COMID from SLCOMPCHARGES S where LOWER(S.NAME) = LOWER(COMPIT); --находим id компенсации
        insert into PAYS (REGISTERLISTID, SLCOMPCHARGESID, WORKCALENDARSID) values (NID, COMID, RK.WID);
       end loop;
      else
        --Уровень региональный
        for RK in (select DD, --заполняем таблицу worktbl 
                          (select case when (select count(*)
                             from WORKCALENDARS W, DAYSWORKCALENDARS D
                            where D.WORKCALENDARSID = W.ID
                              and W.REGIONSRFID = REC.REGION 
                              and D.DATEWC = DD)>0 then
                          (select D.TYPEDAYID
                             from WORKCALENDARS W, DAYSWORKCALENDARS D
                            where D.WORKCALENDARSID = W.ID
                              and W.REGIONSRFID = REC.REGION 
                              and D.DATEWC = DD) else
                           (select D.TYPEDAYID
                             from WORKCALENDARS W, DAYSWORKCALENDARS D
                            where D.WORKCALENDARSID = W.ID
                              and W.REGIONSRFID = SUBID --Российская Федерация
                              and D.DATEWC = DD) end) as STYPE
                     from GENERATE_SERIES(BDATE, EDATE, interval '1 day') as DD)
        loop
          for I in 1 .. NCOUNT
          loop
            insert into WORKTBL (REGISTERLISTID, DATETBL, TYPEDAYID) values (NID, RK.DD, RK.STYPE);
          end loop;
        end loop;
        for RK in (select (SELECT CASE WHEN (select COUNT(*)
                           from WORKCALENDARS W
                          where W.REGIONSRFID = REC.REGION
                            and W.MONTH ::integer = TO_CHAR(DD, 'mm') ::integer )>0 THEN
                         (select W.ID
                           from WORKCALENDARS W
                          where W.REGIONSRFID = REC.REGION
                            and W.MONTH ::integer = TO_CHAR(DD, 'mm') ::integer
                         )
                         ELSE
                         (select W.ID
                           from WORKCALENDARS W
                          where W.REGIONSRFID = SUBID
                            and W.MONTH ::integer = TO_CHAR(DD, 'mm') ::integer
                         )
                         END) as WID
                   from GENERATE_SERIES(BDATE, EDATE + INTERVAL '1 MONTH - 1 DAY', interval '1 month') as DD)
       loop
        select S.ID into COMID from SLCOMPCHARGES S where LOWER(S.NAME) = LOWER(COMPIT); --находим id компенсации
        insert into PAYS (REGISTERLISTID, SLCOMPCHARGESID, WORKCALENDARSID) values (NID, COMID, RK.WID);
       end loop;
      end if;
      
      insert into PAYS
        (REGISTERLISTID, SLCOMPCHARGESID)
        select NID, S.ID
          from SLCOMPCHARGES S
         where LOWER(trim(S.CODE)) in
               ('дот в одинарном размере', 'дот в двойном размере', 'начислено дот за фов', 'дот за активную работу', 'всего');
    end loop;
    --заполняем "сведения о финансировании в зависимости от уровня избирательной компании"
    if REC.LEVEL = 'REGION'
    then
      --Уровень избирательной коммисии региональная
      for RK in (select T.ID
                   from TYPEEXP T
                  where T.MESTIMATE = true
                    and T.REGIONSRFID = REC.REGION)
      loop
      	--Проверяем есть ли записи в таблице.
        if (select count(*)
              from FINEXP S
             where S.TYPEEXPID = RK.ID
               and S.ELECTCOMMINCAMPID = REC.ID) = 0
        then
          insert into FINEXP (TYPEEXPID, ELECTCOMMINCAMPID) values (RK.ID, REC.ID);
        end if;
      end loop;
    elsif REC.LEVEL = 'CENTRAL'
    then
      --Федеральная
      for RK in (select T.ID, REC.ID
                   from TYPEEXP T
                  where T.MESTIMATE = true
                    and T.REGIONSRFID = SUBID)
      loop
        if (select count(*)
              from FINEXP S
             where S.TYPEEXPID = RK.ID
               and S.ELECTCOMMINCAMPID = REC.ID) = 0
        then
          insert into FINEXP (TYPEEXPID, ELECTCOMMINCAMPID) values (RK.ID, REC.ID);
        end if;
      end loop;
    end if;
  
  end loop;
end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_electcommincamp_gen (begindate date, enddate date, leveldcchairman text, ncount integer, idlist text)
  OWNER TO magicbox;
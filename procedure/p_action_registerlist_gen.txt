CREATE OR REPLACE FUNCTION public.p_action_registerlist_gen (
  idlist text,
  uid bigint
)
RETURNS void AS
$body$
declare
  NUID        BIGINT := UID;
  REC         record;
  allS		  record;
  SLCOM       varchar; --код выплаты
  ALG         record;
  SUM_SPRAVKA numeric; --справка о среднем заработке с основного места работы
  SUM_LIMIT   numeric; --предельный размер компенсации
  BUF         numeric [ ];
begin
for allS IN (SELECT S.ID FROM REGISTERLIST S WHERE S.ID = any(P_SYSTEM_GET_SELECTLIST(IDLIST)))LOOP
  for REC in (select S.*,
                     P.ID as PID,
                     P.SLCOMPCHARGESID,
                     (select X.COUNTWD from WORKCALENDARS X where X.ID = P.WORKCALENDARSID) as COUNTWD,
                     P.WORKCALENDARSID,
                     trim(LOWER(SS.CODE)) as SLCOM,
                     COALESCE((select sum(K.WHCOMP)
                                 from WORKTBL K
                                where K.REGISTERLISTID = S.ID
                                  and K.DATETBL in (select SX.DATEWC
                                                      from WORKCALENDARS X, DAYSWORKCALENDARS SX
                                                     where X.ID = P.WORKCALENDARSID
                                                       and SX.WORKCALENDARSID = X.ID)) / 8,
                              0) as SUMM,
                     COALESCE((select sum(K.WHEXTRAWORKDAY) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as WORKDAY_SUMM,
                     COALESCE((select sum(K.WHEXTRANIGHT + K.WHEXTRAHOL) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as SUMX2
              
                from REGISTERLIST S, PAYS P, SLCOMPCHARGES SS
               where S.ID = allS.ID
                 and P.REGISTERLISTID = S.ID
                 and P.SHEETSID is null
                 and SS.ID = P.SLCOMPCHARGESID
                 and trim(LOWER(SS.CODE)) = 'компенсация')
  loop
    update PAYS S
       set NORM      = 0,
           WORKHOURS = 0,
           SUMPAY    = 0,
           PROPPAYS  = null
     where S.ID = REC.PID;
  
    select COALESCE(S.VALUE, 0)
      into SUM_SPRAVKA
      from COMMITTEEMAN C, PERSON P, PERSONSAVSLR S
     where C.ID = REC.COMMITTEEMANID
       and P.ID = C.PERSONID
       and S.PERSONID = P.ID
       and S.BEGINDATE <= NOW()
       and (S.ENDDATE >= NOW() or S.ENDDATE is null);
    select COALESCE(SN.VALUE, 0)
      into SUM_LIMIT
      from REGISTER        R, --расчет
           ELECTCAMPAIGN   I, --избирательная камания
           FEDELECCAMP     N, --нормативный документ
           NORMSFEDEC      SN, --спецификация нормативного документа: расчет оплаты труда
           ELECTCOMMINCAMP KK,
           ELECTCOMMITTEE  K --избирательная коммисия
     where I.ID = R.ELECTCAMPAIGNID
       and N.ID = I.FEDELECCAMPID
       and SN.FEDELECCAMPID = N.ID
       and SN.NAMENORMS = 'limitcomp'
       and KK.ID = R.ELECTCOMMINCAMPID
       and K.ID = KK.ELECTCOMMITTEEID
       and SN.REGIONSRFID = K.REGIONSRFID;
    update PAYS S
       set NORM      = LEAST(SUM_SPRAVKA, SUM_LIMIT) / REC.COUNTWD,
           WORKHOURS = REC.SUMM,
           SUMPAY   =
           (LEAST(SUM_SPRAVKA, SUM_LIMIT) / REC.COUNTWD) * REC.SUMM
     where S.ID = REC.PID;
    SUM_LIMIT   := 0;
    SUM_SPRAVKA := 0;
  end loop;
  for REC in (select S.*,
                     P.ID as PID,
                     P.SLCOMPCHARGESID,
                     (select X.COUNTWD from WORKCALENDARS X where X.ID = P.WORKCALENDARSID) as COUNTWD,
                     P.WORKCALENDARSID,
                     trim(LOWER(SS.CODE)) as SLCOM,
                     COALESCE((select sum(K.WHCOMP)
                                 from WORKTBL K
                                where K.REGISTERLISTID = S.ID
                                  and K.DATETBL in (select SX.DATEWC
                                                      from WORKCALENDARS X, DAYSWORKCALENDARS SX
                                                     where X.ID = P.WORKCALENDARSID
                                                       and SX.WORKCALENDARSID = X.ID)) / 8,
                              0) as SUMM,
                     COALESCE((select sum(K.WHEXTRAWORKDAY) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as WORKDAY_SUMM,
                     COALESCE((select sum(K.WHEXTRANIGHT + K.WHEXTRAHOL) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as SUMX2
              
                from REGISTERLIST S, PAYS P, SLCOMPCHARGES SS
               where S.ID = allS.ID
                 and P.REGISTERLISTID = S.ID
                 and P.SHEETSID is null
                 and SS.ID = P.SLCOMPCHARGESID
                 and trim(LOWER(SS.CODE)) = 'дот в одинарном размере')
  loop
    update PAYS S
       set NORM      = 0,
           WORKHOURS = 0,
           SUMPAY    = 0,
           PROPPAYS  = null
     where S.ID = REC.PID;
    select COALESCE(SN.VALUE, 0)
      into SUM_SPRAVKA
      from REGISTER        R, --расчет
           ELECTCAMPAIGN   I, --избирательная камания
           FEDELECCAMP     N, --нормативный документ
           NORMSFEDEC      SN, --спецификация нормативного документа: расчет оплаты труда
           ELECTCOMMINCAMP KK,
           COMMITTEEMAN    CC,
           ELECTCOMMITTEE  K --избирательная коммисия
     where I.ID = R.ELECTCAMPAIGNID
       and N.ID = I.FEDELECCAMPID
       and SN.FEDELECCAMPID = N.ID
       and SN.NAMENORMS = 'reward' --размер дополнительной оплаты турла
       and KK.ID = R.ELECTCOMMINCAMPID
       and K.ID = KK.ELECTCOMMITTEEID
       and SN.MCIRCUIT = K.MCIRCUIT --полномочия ОИК
       and CC.ID = REC.COMMITTEEMANID
       and R.ID = REC.REGISTERID
       and SN.POSTSID = CC.POSTSID;
  
    select case I.LEVELELCAMPAIGN
             when 'central' then
              K.DISCOEFFFED
             when 'region' then
              K.DISCOEFREG
           end
      into SUM_LIMIT
      from REGISTER R, ELECTCAMPAIGN I, ELECTCOMMITTEE K, COMMITTEEMAN C
     where R.ID = REC.REGISTERID
       and I.ID = R.ELECTCAMPAIGNID
       and K.ID = C.ELECTCOMMITTEEID
       and C.ID = REC.COMMITTEEMANID;
    /*select COALESCE(d.value)
     into sum_limit
     from register r,
        electcampaign i,
        electcommittee k,
          ELECTCOMMINCAMP kk,
          DISCOEFF d --рай кэф
    where r.id = rec.registerid
      and i.id = r.electcampaignid
      and kk.id = r.ELECTCOMMINCAMPID
      and k.ID = kk.ELECTCOMMITTEEid
      and d.electcommitteeid = k.id
      and d.levelelcampaign = i.levelelcampaign; */
    BUF [ 1 ] := SUM_SPRAVKA;
    BUF [ 2 ] := SUM_LIMIT;
    update PAYS S
       set NORM      = BUF [ 1 ],
           WORKHOURS = REC.WORKDAY_SUMM,
           SUMPAY    = BUF [ 1 ] * REC.WORKDAY_SUMM * BUF [ 2 ],
           PROPPAYS  = 'Районный коэффициент = ' || ROUND(BUF [ 2 ], 2)
     where S.ID = REC.PID;
    SUM_LIMIT   := 0;
    SUM_SPRAVKA := 0;
  end loop;
  for REC in (select S.*,
                     P.ID as PID,
                     P.SLCOMPCHARGESID,
                     (select X.COUNTWD from WORKCALENDARS X where X.ID = P.WORKCALENDARSID) as COUNTWD,
                     P.WORKCALENDARSID,
                     trim(LOWER(SS.CODE)) as SLCOM,
                     COALESCE((select sum(K.WHCOMP)
                                 from WORKTBL K
                                where K.REGISTERLISTID = S.ID
                                  and K.DATETBL in (select SX.DATEWC
                                                      from WORKCALENDARS X, DAYSWORKCALENDARS SX
                                                     where X.ID = P.WORKCALENDARSID
                                                       and SX.WORKCALENDARSID = X.ID)) / 8,
                              0) as SUMM,
                     COALESCE((select sum(K.WHEXTRAWORKDAY) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as WORKDAY_SUMM,
                     COALESCE((select sum(K.WHEXTRANIGHT + K.WHEXTRAHOL) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as SUMX2
              
                from REGISTERLIST S, PAYS P, SLCOMPCHARGES SS
               where S.ID = allS.ID
                 and P.REGISTERLISTID = S.ID
                 and P.SHEETSID is null
                 and SS.ID = P.SLCOMPCHARGESID
                 and trim(LOWER(SS.CODE)) = 'дот в двойном размере')
  loop
    update PAYS S
       set NORM      = 0,
           WORKHOURS = 0,
           SUMPAY    = 0,
           PROPPAYS  = null
     where S.ID = REC.PID;
    select COALESCE(SN.VALUE, 0)
      into SUM_SPRAVKA
      from REGISTER        R, --расчет
           ELECTCAMPAIGN   I, --избирательная камания
           FEDELECCAMP     N, --нормативный документ
           NORMSFEDEC      SN, --спецификация нормативного документа: расчет оплаты труда
           ELECTCOMMITTEE  K, --избирательная коммисия
           ELECTCOMMINCAMP KK,
           COMMITTEEMAN    CC
     where I.ID = R.ELECTCAMPAIGNID
       and N.ID = I.FEDELECCAMPID
       and SN.FEDELECCAMPID = N.ID
       and SN.NAMENORMS = 'reward' --размер дополнительной оплаты турла
       and KK.ID = R.ELECTCOMMINCAMPID
       and K.ID = KK.ELECTCOMMITTEEID
       and SN.MCIRCUIT = K.MCIRCUIT --полномочия ОИК
       and CC.ID = REC.COMMITTEEMANID
       and R.ID = REC.REGISTERID
       and SN.POSTSID = CC.POSTSID;
  
    select case I.LEVELELCAMPAIGN
             when 'central' then
              K.DISCOEFFFED
             when 'region' then
              K.DISCOEFREG
           end
      into SUM_LIMIT
      from REGISTER R, ELECTCAMPAIGN I, ELECTCOMMITTEE K, COMMITTEEMAN C
     where R.ID = REC.REGISTERID
       and I.ID = R.ELECTCAMPAIGNID
       and K.ID = C.ELECTCOMMITTEEID
       and C.ID = REC.COMMITTEEMANID;
    /*select COALESCE(d.value)
     into sum_limit
     from register r,
        electcampaign i,
        electcommittee k,
          DISCOEFF d,  --рай кэф
          ELECTCOMMINCAMP kk
    where r.id = rec.registerid
      and i.id = r.electcampaignid
      and kk.id = r.ELECTCOMMINCAMPID
      and k.ID = kk.ELECTCOMMITTEEid
      and d.electcommitteeid = k.id
      and d.levelelcampaign = i.levelelcampaign;*/
    BUF [ 3 ] := SUM_SPRAVKA;
    BUF [ 4 ] := SUM_LIMIT;
    update PAYS S
       set NORM      = BUF [ 3 ] * 2,
           WORKHOURS = REC.SUMX2,
           SUMPAY    = BUF [ 3 ] * 2 * REC.SUMX2 * BUF [ 4 ],
           PROPPAYS  = 'Районный коэффициент = ' || ROUND(BUF [ 4 ], 2)
     where S.ID = REC.PID;
    SUM_LIMIT   := 0;
    SUM_SPRAVKA := 0;
  end loop;
  for REC in (select S.*,
                     P.ID as PID,
                     P.SLCOMPCHARGESID,
                     (select X.COUNTWD from WORKCALENDARS X where X.ID = P.WORKCALENDARSID) as COUNTWD,
                     P.WORKCALENDARSID,
                     trim(LOWER(SS.CODE)) as SLCOM,
                     COALESCE((select sum(K.WHCOMP)
                                 from WORKTBL K
                                where K.REGISTERLISTID = S.ID
                                  and K.DATETBL in (select SX.DATEWC
                                                      from WORKCALENDARS X, DAYSWORKCALENDARS SX
                                                     where X.ID = P.WORKCALENDARSID
                                                       and SX.WORKCALENDARSID = X.ID)) / 8,
                              0) as SUMM,
                     COALESCE((select sum(K.WHEXTRAWORKDAY) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as WORKDAY_SUMM,
                     COALESCE((select sum(K.WHEXTRANIGHT + K.WHEXTRAHOL) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as SUMX2
              
                from REGISTERLIST S, PAYS P, SLCOMPCHARGES SS
               where S.ID = allS.ID
                 and P.REGISTERLISTID = S.ID
                 and P.SHEETSID is null
                 and SS.ID = P.SLCOMPCHARGESID
                 and trim(LOWER(SS.CODE)) = 'начислено дот за фов')
  loop
    update PAYS S
       set NORM      = 0,
           WORKHOURS = 0,
           SUMPAY    = 0,
           PROPPAYS  = null
     where S.ID = REC.PID;
  -- RAISE USING MESSAGE = COALESCE( BUF [ 1 ],0)||' '||COALESCE(REC.WORKDAY_SUMM,0)||' '||COALESCE(BUF [ 3 ],0)||' '||COALESCE(REC.SUMX2,0)||' '||COALESCE(BUF [ 4 ],0);
    update PAYS S
       set NORM      = BUF [ 3 ] * 2 + BUF [ 1 ],
           WORKHOURS = REC.WORKDAY_SUMM + REC.SUMX2,
           SUMPAY    = BUF [ 1 ] * REC.WORKDAY_SUMM * BUF [ 2 ] + BUF [ 3 ] * 2 * REC.SUMX2 * BUF [ 4 ],
           PROPPAYS  = 'ДОТ за ФОВ в одинарном размере =' || ROUND(BUF [ 1 ] * REC.WORKDAY_SUMM * BUF [ 2 ], 2) || '; ДОТ за ФОВ в двойном размере = ' || ROUND(BUF [ 3 ] * REC.SUMX2 * BUF [ 4 ]*2, 2) || '. РК = ' ||
                       ROUND(BUF [ 4 ], 2)
     where S.ID = REC.PID;
    /*'Районный коэффициент = '||sum_spravka  where s.id = rec.pid*/
  end loop;
  
  ------дот за активную работу
  for REC in (select S.*,
                     P.ID as PID,
                     P.SLCOMPCHARGESID,
                     (select X.COUNTWD from WORKCALENDARS X where X.ID = P.WORKCALENDARSID) as COUNTWD,
                     P.WORKCALENDARSID,
                     trim(LOWER(SS.CODE)) as SLCOM,
                     COALESCE((select sum(K.WHCOMP)
                                 from WORKTBL K
                                where K.REGISTERLISTID = S.ID
                                  and K.DATETBL in (select SX.DATEWC
                                                      from WORKCALENDARS X, DAYSWORKCALENDARS SX
                                                     where X.ID = P.WORKCALENDARSID
                                                       and SX.WORKCALENDARSID = X.ID)) / 8,
                              0) as SUMM,
                     COALESCE((select sum(K.WHEXTRAWORKDAY) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as WORKDAY_SUMM,
                     COALESCE((select sum(K.WHEXTRANIGHT + K.WHEXTRAHOL) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as SUMX2
              
                from REGISTERLIST S, PAYS P, SLCOMPCHARGES SS
               where S.ID = allS.ID
                 and P.REGISTERLISTID = S.ID
                 and P.SHEETSID is null
                 and SS.ID = P.SLCOMPCHARGESID
                 and trim(LOWER(SS.CODE)) = 'дот за активную работу')
  loop
    update PAYS S
       set NORM      = 0,
           WORKHOURS = 0,
           SUMPAY    = 0,
           PROPPAYS  = null
     where S.ID = REC.PID;
    -- RAISE USING MESSAGE = REC.REGISTERID||' '||REC.COMMITTEEMANID;
    select sum(P.SUMPAY)
      into SUM_LIMIT
      from REGISTER R, REGISTERLIST L, PAYS P, SLCOMPCHARGES C
     where R.ELECTCAMPAIGNID = (select X.ELECTCAMPAIGNID from REGISTER X where X.ID = REC.REGISTERID)
       --and R.ELECTCOMMINCAMPID = (select X.ELECTCOMMINCAMPID from REGISTER X where X.ID = REC.REGISTERID)
       and L.REGISTERID = R.ID
       and L.COMMITTEEMANID = REC.COMMITTEEMANID
       and P.REGISTERLISTID = L.ID
       and C.ID = P.SLCOMPCHARGESID
       and LOWER(trim(C.CODE)) = 'начислено дот за фов';
    update PAYS S
       set SUMPAY   = SUM_LIMIT * REC.DEPCOEFF,
           PROPPAYS = 'ДОТ за ФОВ = ' || ROUND(SUM_LIMIT, 2) || ' Ведомственный коэффициент = ' || ROUND(REC.DEPCOEFF, 2)
     where S.ID = REC.PID;
    SUM_LIMIT := 0;
  end loop;
  ---------
  for REC in (select S.*,
                     P.ID as PID,
                     P.SLCOMPCHARGESID,
                     (select X.COUNTWD from WORKCALENDARS X where X.ID = P.WORKCALENDARSID) as COUNTWD,
                     P.WORKCALENDARSID,
                     trim(LOWER(SS.CODE)) as SLCOM,
                     COALESCE((select sum(K.WHCOMP)
                                 from WORKTBL K
                                where K.REGISTERLISTID = S.ID
                                  and K.DATETBL in (select SX.DATEWC
                                                      from WORKCALENDARS X, DAYSWORKCALENDARS SX
                                                     where X.ID = P.WORKCALENDARSID
                                                       and SX.WORKCALENDARSID = X.ID)) / 8,
                              0) as SUMM,
                     COALESCE((select sum(K.WHEXTRAWORKDAY) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as WORKDAY_SUMM,
                     COALESCE((select sum(K.WHEXTRANIGHT + K.WHEXTRAHOL) from WORKTBL K where K.REGISTERLISTID = S.ID), 0) as SUMX2
              
                from REGISTERLIST S, PAYS P, SLCOMPCHARGES SS
               where S.ID = allS.ID
                 and P.REGISTERLISTID = S.ID
                 and P.SHEETSID is null
                 and SS.ID = P.SLCOMPCHARGESID
                 and trim(LOWER(SS.CODE)) = 'всего')
  loop
    update PAYS S
       set NORM      = 0,
           WORKHOURS = 0,
           SUMPAY    = 0,
           PROPPAYS  = null
     where S.ID = REC.PID;
    select sum(P.SUMPAY)
      into SUM_LIMIT
      from REGISTERLIST L, PAYS P, SLCOMPCHARGES C
     where L.ID = REC.ID
       and P.REGISTERLISTID = L.ID
       and P.SLCOMPCHARGESID = C.ID
       and trim(C.CODE) in ('Начислено ДОТ за ФОВ', 'Компенсация', 'ДОТ за активную работу');
  
    update PAYS S set SUMPAY = SUM_LIMIT where S.ID = REC.PID;
    SUM_LIMIT := 0;
  end loop;
END LOOP;
end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_registerlist_gen (idlist text, uid bigint)
  OWNER TO magicbox;
CREATE OR REPLACE FUNCTION public.p_action_exec_bud_detail_fill (
  idlist text
)
RETURNS void AS
$body$
/*Отработка детализаций*/
declare
  res text;
  rec record;
  ser record;
  tKBR KBR%rowtype;
  body text;
  leg text;
 begin 
   
  for rec in (
      select d.ID,
             k.DIR_RECIPID,
             k.FUN_CLASSID,
             k.PURP_ARTICLEID,
             k.EXP_TYPEID,
             d.ECON_CLASS_ID,
             d.SUBSIDIES_ID,
             d.CAPOBJECTS_ID,
             d.EVENT_ID,
             d.ACODES_ID,
             d.DEPART5_ID,
             d.DEPART_ID,
             d.DEPART_KOM_ID
        from EXEC_BUD_DETAIL d,
             EXEC_BUD_KBR b,
             KBR k
       where d.id = ANY(p_system_get_selectlist(idlist))
         and b.id = d.exec_bud_kbrid
         and k.ID = b.kbr_id
  )
  loop  
    leg:='   and (ek.DIR_RECIPID = '||REC.DIR_RECIPID||' or ek.DIR_RECIPID is null)
             and (ek.FUN_CLASSID in (WITH RECURSIVE func (ID) AS (
                                             select f1.ID from FUN_CLASS f1 where f1.ID = '||REC.FUN_CLASSID||'
                                             union
                                             select f2.ID from FUN_CLASS f2 inner join FUNC ON (func.ID = f2.HID))
                                             select id from func) or ek.FUN_CLASSID is null)
             and (ek.PURP_ARTICLEID in (WITH RECURSIVE purp (id) AS (
                                             select p1.ID from PURP_ARTICLE p1 where p1.ID = '||REC.PURP_ARTICLEID||'
                                             union
                                             select p2.ID from PURP_ARTICLE p2 inner join PURP ON (purp.ID = p2.HID))
                                             select id from purp) or ek.PURP_ARTICLEID is null)
             and (ek.EXP_TYPEID in (WITH RECURSIVE exp (ID) AS (
                                             select p1.ID from EXP_TYPE p1 where p1.ID = '||REC.EXP_TYPEID||'
                                             union
                                             select p2.ID from EXP_TYPE p2 inner join exp on (exp.ID = p2.HID))
                                             select id from exp) or ek.EXP_TYPEID is null)
          order by e.PRIORITY';
  
   if rec.ECON_CLASS_ID is null THEN
      for ser in execute
          'select e.ECON_CLASS_ID
             from DEFAULT_ECON_CLASS e,
                  DEFAULT_ECON_CLASS_KBR ek
           where ek.DEFAULT_ECON_CLASS_ID = e.ID'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set ECON_CLASS_ID = ser.ECON_CLASS_ID where d.ID = rec.ID;
      end loop;
   end if;
   if rec.SUBSIDIES_ID is null THEN
      for ser in execute
          'select e.SUBSIDIES_ID
             from DEFAULT_SUBSIDIES e,
                  DEFAULT_SUBSIDIES_KBR ek
            where ek.DEFAULT_SUBSIDIES_ID = e.ID'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set SUBSIDIES_ID = ser.SUBSIDIES_ID where d.ID = rec.ID;
      end loop;
   end if;
   if rec.CAPOBJECTS_ID is null THEN
      for ser in execute
          'select e.CAPOBJECTS_ID
             from DEFAULT_CAPOBJECTS e,
                  DEFAULT_CAPOBJECTS_KBR ek
            where ek.DEFAULT_CAPOBJECTS_ID = e.ID'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set CAPOBJECTS_ID = ser.CAPOBJECTS_ID where d.ID = rec.ID;
      end loop;
   end if;
   if rec.EVENT_ID is null THEN
      for ser in execute
          'select e.EVENT_ID
             from DEFAULT_EVENT e,
                  DEFAULT_EVENT_KBR ek
            where ek.DEFAULT_EVENT_ID = e.id'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set EVENT_ID = ser.EVENT_ID where d.ID = rec.ID;
      end loop;
   end if;
   if rec.ACODES_ID is null THEN
      for ser in execute
          'select e.ACODES_ID
             from DEFAULT_ACODES e,
                 DEFAULT_ACODES_KBR ek
           where ek.DEFAULT_ACODES_ID = e.id'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set ACODES_ID = ser.ACODES_ID where d.ID = rec.ID;
      end loop;
   end if;
   if rec.DEPART5_ID is null THEN
      for ser in execute
          'select e.DEPART5_ID
             from DEFAULT_DEPART5 e,
                  DEFAULT_DEPART5_KBR ek
            where ek.DEFAULT_DEPART5_ID = e.id'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set DEPART5_ID = ser.DEPART5_ID where d.ID = rec.ID;
      end loop;
   end if;
   if rec.DEPART_ID is null THEN
      for ser in execute
          'select e.DEPART_ID
             from DEFAULT_DEPART e,
                  KBR_KAR ek
            where ek.DEFAULT_DEPART_ID = e.id'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set DEPART_ID = ser.DEPART_ID where d.ID = rec.ID;
      end loop;
   end if;
   if rec.DEPART_KOM_ID is null THEN
      for ser in execute
          'select e.DEPART_ID
             from DEFAULT_DEPART e,
                  KBR_KOM ek
            where ek.DEFAULT_DEPART_ID = e.id'
            ||leg
      loop
          update EXEC_BUD_DETAIL d set DEPART_ID_KOM = ser.DEPART_ID where d.ID = rec.ID;
      end loop;
   end if;
  end loop;  
 end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_exec_bud_detail_fill (idlist text)
  OWNER TO magicbox;
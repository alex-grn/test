CREATE OR REPLACE FUNCTION public.p_action_exec_bud_detail_fill_code (
  id bigint,
  ndepart_id bigint = NULL::bigint,
  ndepart_id_kom bigint = NULL::bigint,
  necon_class_id bigint = NULL::bigint,
  nsubsidies_id bigint = NULL::bigint,
  ncapobjects_id bigint = NULL::bigint,
  nevent_id bigint = NULL::bigint,
  nacodes_id bigint = NULL::bigint,
  ndepart5_id bigint = NULL::bigint
)
RETURNS text AS
$body$
 declare
   rec RECORD;
   nID BIGINT:=ID;
 begin
   for rec in (
       select COALESCE(d.code,'')||COALESCE(f.code,'')||COALESCE(p.code,'')||COALESCE(e.code,'') as kbk,
              
              COALESCE(g.DEPART_C,'0') as DEPART_C,
              COALESCE(g.DEPART_C_KOMC,'0') as DEPART_C_KOMC,
              COALESCE(g.ECON_CLASS_C,'0') as ECON_CLASS_C,
              COALESCE(g.SUBSIDIES_C,'0') as SUBSIDIES_C,
              COALESCE(g.CAPOBJECTS_C,'0') as CAPOBJECTS_C,
              COALESCE(g.EVENT_C,'0') as EVENT_C,
              COALESCE(g.ACODES_C,'0') as ACODES_C,
              COALESCE(g.DEPART5_C,'0') as DEPART5_C,
              
              COALESCE(dep.code,'') as DEPCODE,
              COALESCE(depc.code,'') as DEPCCODE,
              COALESCE(ec.code,'') as ECCODE,
              COALESCE(su.code,'') as SUCODE,
              COALESCE(ca.code,'') as CACODE,
              COALESCE(ev.code,'') as EVCODE,
              COALESCE(ac.code,'') as ACCODE,
              COALESCE(d5.code,'') as D5CODE
              
         from EXEC_BUD_KBR k 
        inner join KBR kb on kb.ID = k.KBR_ID
         left join DIR_RECIP d on d.ID = kb.DIR_RECIPID
         left join FUN_CLASS f on f.ID = kb.FUN_CLASSID
         left join PURP_ARTICLE p on p.ID = kb.PURP_ARTICLEID
         left join EXP_TYPE e on e.ID = kb.EXP_TYPEID
        inner join EXEC_BUD g on g.ID = k.EXEC_BUDID
         left join DEPART dep on dep.id = ndepart_id
         left join DEPART depc on depc.id = ndepart_id_kom
         left join ECON_CLASS ec on ec.id = necon_class_id
         left join SUBSIDIES su on su.id = nsubsidies_id
         left join CAPOBJECTS ca on ca.id = ncapobjects_id
         left join EVENTS ev on ev.id = nevent_id
         left join ACODES ac on ac.id = nacodes_id
         left join DEPART5 d5 on d5.id = ndepart5_id
        where k.ID = nID
   )
   LOOP
   
    for i in 1..8 LOOP
         if rec.DEPART_C = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.DEPCODE;
         elsif rec.DEPART_C_KOMC = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.DEPCCODE;
         elsif rec.ECON_CLASS_C = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.ECCODE; 
         elsif rec.SUBSIDIES_C = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.SUCODE;   
         elsif rec.CAPOBJECTS_C = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.CACODE;   
         elsif rec.EVENT_C = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.EVCODE;   
         elsif rec.ACODES_C = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.ACCODE;   
         elsif rec.DEPART5_C = i::text THEN
            rec.KBK:=rec.KBK||' '|| rec.D5CODE;   
         end if; 
     end loop;
     return REGEXP_REPLACE(rec.KBK, '  *', ' ');
   END LOOP;
   
 end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_exec_bud_detail_fill_code (id bigint, ndepart_id bigint, ndepart_id_kom bigint, necon_class_id bigint, nsubsidies_id bigint, ncapobjects_id bigint, nevent_id bigint, nacodes_id bigint, ndepart5_id bigint)
  OWNER TO magicbox;
CREATE OR REPLACE FUNCTION public.p_action_fin_deleteentryrr (
  idlist text
)
RETURNS void AS
$body$
declare
  rec     RECORD;
  nUID   bigint:=UID;
begin

 for rec in (
      select k.id/*,
             d.keyout*/
        from EXPSHD k/*,
             doclinks d*/
       where k.id = any(p_system_get_selectlist(idlist))/*
         and d.tablein ilike 'EXPSHD'
         and d.keyin = k.id
         and d.tableout ilike 'JURNALEXP'*/
  )  
  loop
       --perform p_system_mdl_table('delete','jurnalexp','{"id":'||rec.keyout||'}',NULL,UID);
        delete from JURNALEXP j where exists (select 1
                                             from DOCLINKS d
                                            where d.TABLEIN ilike 'EXPSHD'
                                              and d.KEYIN = rec.ID
                                              and d.TABLEOUT ilike 'JURNALEXP'
                                              and d.KEYOUT = j.ID);
        PERFORM P_SYSTEM_DOCLINKS_DEL('EXPSHD',rec.ID,'JURNALEXP');
        PERFORM P_ACTION_SET_STATUS('EXPSHD',rec.ID::text,'0');
  end loop;
  
  --если есть связь с расходным расписанием то переводим статус в расходном расписании в черновик
  for rec in (
      select d.keyin
        from EXPSHD k,
             doclinks d
       where k.id = any(p_system_get_selectlist(idlist))
         and d.tableout ilike 'EXPSHD'
         and d.keyout = k.id
         and d.tablein ilike 'DISTRIBDATA' 
  ) 
  loop 
     PERFORM p_action_fin_deleteentrydd(rec.keyin::text,nUID);
  end loop;
end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_fin_deleteentryrr (idlist text)
  OWNER TO magicbox;
CREATE OR REPLACE FUNCTION public.p_action_fin_makeentrydet (
  idlist text,
  uid bigint
)
RETURNS void AS
$body$
/*Отработка детализаций*/
declare
  nUID  BIGINT:=UID;
  nLID  BIGINT:=P_SYSTEM_GEN_LID('JURNALEXP',nUID);
  RC    RECORD;
  JURNALEXPID bigint;
  nTYPEID     bigint;
  nDET        bigint;
begin
  
   FOR RC IN (
       select F.ID,
              F.BUDGETS_ID,
              F.DOCNUMB,
              F.DOCDATE,
              F.NOTE,
              d.RECORD_TYPE,
              d.YEAR_U,
              d.KBR_ID,
              sum(k.SUM_SER)-d.SUM_IN as summ,
              array_agg(k.ID) as DETAIL_KBR_DID
         from DETAIL f,
              DETAIL_KBR d,
              DETAIL_KBR_D k
        where f.ID = ANY(P_SYSTEM_GET_SELECTLIST(IDLIST))
          and d.DETAILID = f.ID
          and k.DETAIL_KBRID = d.ID
     group by F.ID, F.BUDGETS_ID, F.DOCNUMB, 
              F.DOCDATE, F.NOTE, d.SUM_IN, 
              d.YEAR_U, d.KBR_ID, d.RECORD_TYPE
             
   )
   LOOP
      if RC.SUMM != 0 THEN
         raise using message = 'Детализированна не вся сумма!';
      end if;
      select r.ID
        into nTYPEID
        from RECORD_TYPES r
       where r.RECORD_TYPE ilike RC.RECORD_TYPE;
       insert into JURNALEXP(UID,LID,RECORD_TYPESID,RECORD_DATE,BUDGETS_ID,YEAR_U,KBR_ID,DOCTYPE,DOCNUMB,DOCDATE,SUM,NOTE/*,AGENT_ACC_ID*/)
       values(nUID,nLID,nTYPEID,RC.DOCDATE,RC.BUDGETS_ID,RC.YEAR_U,RC.KBR_ID,'Детализация бюджетных данных',RC.DOCNUMB,RC.DOCDATE,RC.SUMM,RC.NOTE/*,RC.AGENT_ACC_ID*/)
       returning JURNALEXP.ID into JURNALEXPID;
       foreach nDET in array RC.DETAIL_KBR_DID
       loop
           PERFORM P_SYSTEM_DOCLINKS_ADD('DETAIL_KBR_D',nDET,'JURNALEXP',JURNALEXPID);
       end loop;
   END LOOP;
   PERFORM p_action_set_status('DETAIL',RC.ID::text,'1');
end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_fin_makeentrydet (idlist text, uid bigint)
  OWNER TO magicbox;
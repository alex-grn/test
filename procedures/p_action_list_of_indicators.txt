CREATE OR REPLACE FUNCTION public.p_action_list_of_indicators (
  idlist text,
  uid bigint,
  tablename text
)
RETURNS void AS
$body$
 declare
   nUID bigint:=UID;     
   rec  record;
   ins  record;
   last_date date;
   list_tables_uik text[]:=ARRAY['ACCOUNTABILITYUIKS1SD','ACCOUNTABILITYUIKS2AE','UIKPRIL2','UIKPRIL6','UIKPRIL8','UIKPRIL9','UIKPRIL11','UIKPRIL15'];
   list_tables_tik text[]:=ARRAY['ACCOUNTABILITYTIKS1SD','ACCOUNTABILITYTIKS2AE','TIKPRIL2','TIKPRIL4','TIKPRIL5','TIKPRIL6','TIKPRIL7','TIKPRIL8','TIKPRIL9','TIKPRIL10','TIKPRIL11','TIKPRIL12','TIKPRIL13','TIKPRIL14','TIKPRIL15','TIKPRIL16','TIKPRIL17'];
   list_tables_iksrf text[]:=ARRAY['ACCOUNTABILITYIKSRFS1SD','ACCOUNTABILITYIKSRFS2AE','IKSRFPRIL1','IKSRFPRIL2','IKSRFPRIL3','IKSRFPRIL4','IKSRFPRIL5','IKSRFPRIL6','IKSRFPRIL7','IKSRFPRIL8','IKSRFPRIL9','IKSRFPRIL10','IKSRFPRIL11','IKSRFPRIL12','IKSRFPRIL13','IKSRFPRIL14','IKSRFPRIL15','IKSRFPRIL15A','IKSRFPRIL16','IKSRFPRIL17'];
   list_tables text[]:=(select case upper(tablename) when 'ACCOUNTABILITYUIK' then list_tables_uik when 'ACCOUNTABILITYTIK' then list_tables_tik when 'ACCOUNTABILITYIKSRF' then list_tables_iksrf end);
   tTYPE TEXT:=(select case upper(tablename) when 'ACCOUNTABILITYUIK' then 'UIK' when 'ACCOUNTABILITYTIK' then 'TIK' when 'ACCOUNTABILITYIKSRF' then 'IKSRF' end);
   tables      text;
 begin
   for rec in EXECUTE
      'select t.id
         from '||tablename||' t
        where t.id = ANY(p_system_get_selectlist('''||idlist||'''))'
   
   loop --raise using message = list_tables;
     FOREACH tables IN array list_tables
     loop
      for ins in execute
     'select w.id as wid,
             m.id as mid
        from REPORTINGFORM r,
             PKTO p,
             WORDINGOFTHEFORMS w,
             MEASURESOFSHAPE m
       where p.REPORTINGFORMID = r.id
         and p_find_name_from_list(''PKTO'',''NAMETABLE'||tTYPE||''',p.nametable'||tTYPE||') = '''||tables||'''
         and w.reportingformid = r.id
         and w.revisiondate = (select MAX(wm.revisiondate) from WORDINGOFTHEFORMS wm where wm.reportingformid = w.reportingformid)
         and m.wordingoftheformsid = w.id
         and m.completionuik
         and not EXISTS(select 1
                          from '||tables||' t
                         where t.measuresofshapeid = m.id
                           and t.'||tablename||'id = '||rec.id||')'
       loop
       execute
           'insert into '||tables||'(uid,'||tablename||'id,wordingoftheformsid,measuresofshapeid,'||tTYPE||'referendumcommission)
                         values('||nUID||','||rec.id||','||ins.wid||','||ins.mid||',0);';
       end loop;
       for ins in execute  
       'select w.revisiondate from '||tables||' t, WORDINGOFTHEFORMS w where t.'||tablename||'id = '||rec.id||' and w.id = t.wordingoftheformsid'
       loop
        last_date:=ins.revisiondate;
       end loop;
       if last_date is not null then
       execute
       'delete from '||tables||' tt where tt.id in (select t2.id
                                                            from '||tables||' t,
                                                                 MEASURESOFSHAPE m,
                                                                 WORDINGOFTHEFORMS w,
                                                                 
                                                                 '||tables||' t2,
                                                                 MEASURESOFSHAPE m2,
                                                                 WORDINGOFTHEFORMS w2
                                                           where t.'||tablename||'id = '||rec.id||'
                                                             and m.id = t.measuresofshapeid
                                                             and w.id = m.wordingoftheformsid
                                                             and w.revisiondate = '''||last_date||'''
                                                             
                                                             and t2.'||tablename||'id = t.'||tablename||'id
                                                             and m2.id = t2.measuresofshapeid
                                                             and w2.id = m2.wordingoftheformsid
                                                             and w2.revisiondate < '''||last_date||'''
                                                             and m.code = m2.code)';   
       end if;
     end loop;
   end loop; 
  
 end;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.p_action_list_of_indicators (idlist text, uid bigint, tablename text)
  OWNER TO magicbox;
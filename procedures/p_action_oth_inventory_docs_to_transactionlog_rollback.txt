CREATE OR REPLACE FUNCTION public.p_action_oth_inventory_docs_to_transactionlog_rollback(id bigint)
  
RETURNS text AS
$BODY$
/*Действие: Отмена проведения документа в учете*/
declare
  nID    BIGINT:=ID;  
  REC    record;
  aINVENT TEXT[]:= ARRAY['INVENTORY_TRIAL_BALANCEDOCS','INVENTORY_TRIAL_BALANCE_DICNOMNS'];
  aOTHERS TEXT[]:= ARRAY['INVENTORY_TRIAL_BALANCE_CHANGE','TRANSACTIONLOG_DOCS','TRANSACTIONLOG_STAGES'];
  tINVENT text;
begin
  --Сменим статус на "В работе"
  update OTHER_INVENTORY_DOCS p set STATUS = '1' where p.ID = nID;
  --Удалим записи из разделов
  FOREACH tINVENT IN array aOTHERS
    loop
       execute 'delete from '||tINVENT||' t
                      where exists(select 1
                                     from doclinks d
                                    where d.tablein ilike ''OTHER_INVENTORY_DOCS''
                                      and d.keyin = '||nID||'
                                      and d.tableout ilike '''||tINVENT||'''
                                      and t.id = d.keyout);';
    end loop;
  --смотрим есть ли записи. НЕТ? удаляем родителей ????  
  delete from INVENTORY_TRIAL_BALANCE_DICNOMNS t 
                      where exists(select 1
                                     from doclinks d
                                    where d.tablein ilike 'OTHER_INVENTORY_DOCS'
                                      and d.keyin = nID
                                      and d.tableout ilike 'INVENTORY_TRIAL_BALANCE_DICNOMNS'
                                      and t.id = d.keyout)
                        and not exists(select 1
                                         from INVENTORY_TRIAL_BALANCE_CHANGE s
                                        where s.INVENTORY_TRIAL_BALANCE_DICNOMNSID = t.ID);  
  delete from INVENTORY_TRIAL_BALANCEDOCS t
                      where exists(select 1
                                     from doclinks d
                                    where d.tablein ilike 'OTHER_INVENTORY_DOCS'
                                      and d.keyin = nID
                                      and d.tableout ilike 'INVENTORY_TRIAL_BALANCEDOCS'
                                      and t.id = d.keyout)
                        and not exists(select 1 
                                         from INVENTORY_TRIAL_BALANCE_DICNOMNS dd,
                                              INVENTORY_TRIAL_BALANCE_CHANGE s
                                        where dd.INVENTORY_TRIAL_BALANCEDOCSID = t.ID
                                          and s.INVENTORY_TRIAL_BALANCE_DICNOMNSID = dd.ID);

  -- удаляем связи
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'TRANSACTIONLOG',NULL);
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'INVENTORY_TRIAL_BALANCE',NULL,false);

  /*
  --Удалим все связи с журналом операций
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'TRANSACTIONLOG',NULL,false);
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'TRANSACTIONLOG_DOCS',NULL,false);
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'TRANSACTIONLOG_STAGES',NULL,false);
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'INVENTORY_TRIAL_BALANCE',NULL,false);
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'INVENTORY_TRIAL_BALANCEDOCS',NULL,false);
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'INVENTORY_TRIAL_BALANCE_DICNOMNS',NULL,false);
  perform p_system_doclinks_del('OTHER_INVENTORY_DOCS',nID,'INVENTORY_TRIAL_BALANCE_CHANGE',NULL,false);
  
  for rec in (
      select p.ID
        from OTHER_INVENTORY_DOCS sp,
             INVENTORY p
       where sp.ID = nID
         and p.ID = sp.INVENTORYID
  )
  loop
       perform p_system_doclinks_del('INVENTORY',rec.ID,'TRANSACTIONLOG',NULL,false);
       perform p_system_doclinks_del('INVENTORY',rec.ID,'TRANSACTIONLOG_DOCS',NULL,false);
       perform p_system_doclinks_del('INVENTORY',rec.ID,'TRANSACTIONLOG_STAGES',NULL,false);
       perform p_system_doclinks_del('INVENTORY',rec.ID,'INVENTORY_TRIAL_BALANCE',NULL,false);
       perform p_system_doclinks_del('INVENTORY',rec.ID,'INVENTORY_TRIAL_BALANCEDOCS',NULL,false);
       perform p_system_doclinks_del('INVENTORY',rec.ID,'INVENTORY_TRIAL_BALANCE_DICNOMNS',NULL,false);
       perform p_system_doclinks_del('INVENTORY',rec.ID,'INVENTORY_TRIAL_BALANCE_CHANGE',NULL,false);
  end loop;
  for rec in (
      select p.ID
        from OTHER_INVENTORY_GOODS p
       where p.OTHER_INVENTORY_DOCSID = nID
  )
  loop
       perform p_system_doclinks_del('OTHER_INVENTORY_GOODS',rec.ID,'TRANSACTIONLOG',NULL,false);
       perform p_system_doclinks_del('OTHER_INVENTORY_GOODS',rec.ID,'TRANSACTIONLOG_DOCS',NULL,false);
       perform p_system_doclinks_del('OTHER_INVENTORY_GOODS',rec.ID,'TRANSACTIONLOG_STAGES',NULL,false);
       perform p_system_doclinks_del('OTHER_INVENTORY_GOODS',rec.ID,'INVENTORY_TRIAL_BALANCE',NULL,false);
       perform p_system_doclinks_del('OTHER_INVENTORY_GOODS',rec.ID,'INVENTORY_TRIAL_BALANCEDOCS',NULL,false);
       perform p_system_doclinks_del('OTHER_INVENTORY_GOODS',rec.ID,'INVENTORY_TRIAL_BALANCE_DICNOMNS',NULL,false);
       perform p_system_doclinks_del('OTHER_INVENTORY_GOODS',rec.ID,'INVENTORY_TRIAL_BALANCE_CHANGE',NULL,false);
  end loop;
*/  
  return 'Отмена проведения документа в учёте выполнена';
end;
$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;

ALTER FUNCTION public.p_action_oth_inventory_docs_to_transactionlog_rollback(bigint)
  OWNER TO magicbox;

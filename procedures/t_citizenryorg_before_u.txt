CREATE OR REPLACE FUNCTION public.t_citizenryorg_before_u (
)
RETURNS trigger AS
$body$
BEGIN

  --При заполненом "Дата прибытия", статус автоматически устанавливается  на "Проходит АГС"
  IF (SELECT R.ARRIVALDATEACTUAL FROM PASSAGEAGSCIT R WHERE R.CITIZENRYID = NEW.CITIZENRYID) IS NOT NULL THEN
    NEW.STATUSCITIZEN := '3'; --проходит АГС
  END IF;
  
  --При заполненом "Дата увольнения", статус автоматически устанавливается  на "Уволен со службы"
  IF NEW.DATEOFDISMISSAL IS NOT NULL THEN 
    NEW.STATUSCITIZEN := '4'; --уволен со службы
  END IF;

  RETURN NEW;
  
END;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER
COST 100;

ALTER FUNCTION public.t_citizenryorg_before_u ()
  OWNER TO magicbox;

CREATE TRIGGER trg_citizenryorg_before_u
  BEFORE UPDATE 
  ON public.citizenryorg
  
FOR EACH ROW 
  EXECUTE PROCEDURE public.t_citizenryorg_before_u();

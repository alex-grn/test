<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="Areport_benefit01.xls" documentPath="Areport_benefit01.xls" outputType="xls" outputNamePattern="Areport_benefit01.xls"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="Header" orientation="H">
				<queries>
                     <query name="Header" type="sql">
                        <script>
							select 
									case ${repmonth}::integer
									 when 1 then '€нварь'
									 when 2 then 'февраль'
									 when 3 then 'март'
									 when 4 then 'апрель'
									 when 5 then 'май'
									 when 6 then 'июнь'
									 when 7 then 'июль'
									 when 8 then 'август'
									 when 9 then 'сент€брь'
									 when 10 then 'окт€брь'
									 when 11 then 'но€брь'
									 when 12 then 'декабрь'
									 end
									 ||'-'||
									 case ${repmonthby}::integer
									 when 1 then '€нварь'
									 when 2 then 'февраль'
									 when 3 then 'март'
									 when 4 then 'апрель'
									 when 5 then 'май'
									 when 6 then 'июнь'
									 when 7 then 'июль'
									 when 8 then 'август'
									 when 9 then 'сент€брь'
									 when 10 then 'окт€брь'
									 when 11 then 'но€брь'
									 when 12 then 'декабрь'
									 end
									 ||' '||${repyear}::text||' года'  as DATEREPORT,
									 to_char(now(),'dd.mm.yyyy') as now_date
						</script>
                     </query>
                </queries>
			</band>		
			<band name="spec" orientation="H">
				<queries>
                    <query name="spec" type="sql">
                        <script>
								select 'ќбщий итог:' as FED,
                             coalesce((select sum(COALESCE(TBL.COUNTER, 0))
									from (select (select sum(TBL2.COUNTER)
													from (select count(distinct X.BENEFITSRECIPIENTSID) as COUNTER
															from BENEFIT04       X,
																BENEFITSPACKETS XX,
																SUBJECTSDIR     D
															where XX.ID = X.BENEFITSPACKETSID
															and D.ID = XX.SUBJECTSDIRID
															and XX.REPMONTH = BN.REPMONTH
															and XX.REPYEAR = ${repyear}::INTEGER
															group by D.CODE) as TBL2) as COUNTER
											from BENEFIT04       B1,
												BENEFITSPACKETS BN
											where BN.ID = B1.BENEFITSPACKETSID
											and BN.REPMONTH ::integer between ${repmonth}::integer and ${repmonthby}::integer
											and BN.REPYEAR = ${repyear}::INTEGER
											group by BN.REPMONTH) TBL),0) as CHISL,
                             COALESCE(sum((select sum(COALESCE(P.PAYSUM, 0)) from BENEFIT04PAYMENT P where B.ID = P.BENEFIT04ID)), 0) as POSOB,
                             sum((select count(DISTINCT c.benefitchildid) from BENEFIT04PAYMENT P, child04 c
                                                                                    where B.ID = P.BENEFIT04ID and c.id = p.child04id
                                                                                                   )) as count_r1
                        from SUBJECTSDIR R
                        left join BENEFITSPACKETS Z
                          on R.ID = Z.SUBJECTSDIRID
                         and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
						 and z.repyear = ${repyear}::INTEGER
                        left join BENEFIT04 B
                          on B.BENEFITSPACKETSID = Z.ID;
                        </script>
                    </query>
                </queries>
            </band>
            <band name="spec1" orientation="H">
				<bands>
					<band name="spec2" orientation="H">
						<queries>
                            <query name="spec2" type="sql">
                                <script>
								 select 
										R.NAME as FED,
										R.FEDREG,
										coalesce((select sum(COALESCE(tbl.counter,0))
										from (select 
												(select sum(tbl2.counter) 
													from    (select count(DISTINCT x.benefitsrecipientsid) as counter
															from BENEFIT04       X,
																	BENEFITSPACKETS XX,
																	SUBJECTSDIR     D
															where XX.ID = X.BENEFITSPACKETSID
																and D.ID = XX.SUBJECTSDIRID
																and xx.repmonth = bn.repmonth
																and xx.subjectsdirid = bn.subjectsdirid
																and xx.repyear = ${repyear}::INTEGER
																group by d.code) as tbl2) as counter
									from BENEFIT04       b1,
										BENEFITSPACKETS bn,
										subjectsdir sb
								where bn.ID = b1.BENEFITSPACKETSID
									and bn.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
									and bn.repyear = ${repyear}::INTEGER
									and sb.id = bn.subjectsdirid 
									and sb.name = r.name
									group by bn.repmonth,bn.subjectsdirid ) tbl),0) as CHISL,
										COALESCE(sum((select sum(COALESCE(P.PAYSUM, 0)) from BENEFIT04PAYMENT P where B.ID = P.BENEFIT04ID)), 0) as POSOB,
										sum((select count(DISTINCT c.benefitchildid) from BENEFIT04PAYMENT P, child04 c
                                                                                    where B.ID = P.BENEFIT04ID and c.id = p.child04id
                                                                                                   )) as count_r1
									from SUBJECTSDIR R
									left join BENEFITSPACKETS Z
									on R.ID = Z.SUBJECTSDIRID
									and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
									and z.repyear = ${repyear}::INTEGER
									left join BENEFIT04 B
									on B.BENEFITSPACKETSID = Z.ID
								where R.FEDREG = ${spec1.FED}
								group by R.NAME,R.FEDREG
								order by min(r.CODE);
                                </script>
                            </query>
                        </queries>
					</band>
				</bands>
                <queries>
                    <query name="spec1" type="sql">
                        <script>
                            select 
               		  R.FEDREG as FED,
                     coalesce((select sum(COALESCE(tbl.counter,0))
										from (select 
												(select sum(tbl2.counter) 
													from    (select count(DISTINCT x.benefitsrecipientsid) as counter
															from BENEFIT04       X,
																	BENEFITSPACKETS XX,
																	SUBJECTSDIR     D
															where XX.ID = X.BENEFITSPACKETSID
																and D.ID = XX.SUBJECTSDIRID
																and xx.repmonth = bn.repmonth
																and xx.subjectsdirid = bn.subjectsdirid
																and xx.repyear = ${repyear}::INTEGER
																group by d.code) as tbl2) as counter
									from BENEFIT04       b1,
										BENEFITSPACKETS bn,
										subjectsdir sb
								where bn.ID = b1.BENEFITSPACKETSID
									and bn.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
									and bn.repyear = ${repyear}::INTEGER
									and sb.id = bn.subjectsdirid 
									and sb.fedreg = r.fedreg
									group by bn.repmonth,bn.subjectsdirid ) tbl),0) as CHISL,
                     COALESCE(sum((select sum(COALESCE(P.PAYSUM, 0)) from BENEFIT04PAYMENT P where B.ID = P.BENEFIT04ID)), 0) as POSOB,
                     sum((select count(DISTINCT c.benefitchildid) from BENEFIT04PAYMENT P, child04 c
                                                                                    where B.ID = P.BENEFIT04ID and c.id = p.child04id
                                                                                                   )) as count_r1
                from SUBJECTSDIR R
                left join BENEFITSPACKETS Z
                  on R.ID = Z.SUBJECTSDIRID
                 and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     			 and z.repyear = ${repyear}::INTEGER
                left join BENEFIT04 B
                  on B.BENEFITSPACKETSID = Z.ID
               group by R.FEDREG
			   order by min(r.CODE);
                        </script>
                    </query>
                </queries>
            </band>
        </bands>
        <queries/>
    </rootBand>
</report>
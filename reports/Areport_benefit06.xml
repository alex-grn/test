<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="Areport_benefit01.xls" documentPath="Areport_benefit01.xls" outputType="xls" outputNamePattern="Areport_benefit01.xls"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="Header" orientation="H">
				<queries>
                     <query name="Header" type="sql">
                        <script>
							select 'за период с '||
									case ${repmonth}::integer
									 when 1 then '€нвар€'
									 when 2 then 'феврал€'
									 when 3 then 'марта'
									 when 4 then 'апрел€'
									 when 5 then 'ма€'
									 when 6 then 'июн€'
									 when 7 then 'июл€'
									 when 8 then 'августа'
									 when 9 then 'сент€бр€'
									 when 10 then 'окт€бр€'
									 when 11 then 'но€бр€'
									 when 12 then 'декабр€'
									 end
									 ||' по '||
									 case ${repmonthby}::integer
									 when 1 then '€нварь'
									 when 2 then 'февраль'
									 when 3 then 'март'
									 when 4 then 'апрель'
									 when 5 then 'май'
									 when 6 then 'июнь'
									 when 7 then 'июль'
									 when 8 then 'август'
									 when 9 then 'сент€брь'
									 when 10 then 'окт€брь'
									 when 11 then 'но€брь'
									 when 12 then 'декабрь'
									 end
									 ||' '||${repyear}::text||' года'  as DATEREPORT
						</script>
                     </query>
                </queries>
			</band>		
			<band name="spec" orientation="H">
				<queries>
                    <query name="spec" type="sql">
                        <script>
							select 'ќбщий итог:' as FED,(select count(xx.id) from benefit06 xx, BENEFITSPACKETS Z, subjectsdir c  where xx.benefitspacketsid = Z.ID  and c.id = z.subjectsdirid
								and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     									and z.repyear = ${repyear}::INTEGER) as CHISL, sum(rcof) as RASCHET,sum(pay) as POSOB
							from(select 	 count(b.id) as FED, 
							 count(b.id)*
                                (select COALESCE(st.min,0)
                                from benefitstypedir p,
                                	 benefitsindexdir t,
                                	 benefitsindexdirhistory ST
                               where p.rosternumber = 6
                                and t.benefitstypenamedirid = p.id 
                                and st.benefitsindexdirid = t.id
                                and st.paydatefrom = (select max(xx.paydatefrom) from benefitsindexdirhistory xx where xx.benefitsindexdirid = t.id and (z.repyear||'-'||z.repmonth||'-01')::date >= xx.paydatefrom))*
                                COALESCE(P.coefficient,0) AS RCOF,
								coalesce(SUM((SELECT sum(COALESCE(vv.PAYSUM,0))  
												FROM  BENEFIT06PAYMENT vv 
											   WHERE B.ID = vv.benefit06id
                                                 and vv.coefficient = p.coefficient)),0) AS PAY,
								(select COALESCE(st.min,0)
                                from benefitstypedir p,
                                	 benefitsindexdir t,
                                	 benefitsindexdirhistory ST
                               where p.rosternumber = 6
                                and t.benefitstypenamedirid = p.id 
                                and st.benefitsindexdirid = t.id
                                and st.paydatefrom = (select max(xx.paydatefrom) from benefitsindexdirhistory xx where xx.benefitsindexdirid = t.id and (z.repyear||'-'||z.repmonth||'-01')::date >= xx.paydatefrom  )) as norma
						     from BENEFIT06 B
					   INNER JOIN BENEFITSPACKETS Z ON B.benefitspacketsid = Z.ID 
					   and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     						and z.repyear = ${repyear}::INTEGER
						left join BENEFIT06PAYMENT p on p.benefit06id = b.id 	
					   right JOIN subjectsdir R ON Z.subjectsdirID = R.ID
					   --входной параметр
 					--	GROUP BY R.fedreg;
                    GROUP BY r.name,P.coefficient,norma)  r;
                        </script>
                    </query>
                </queries>
            </band>
            <band name="spec1" orientation="H">
				<bands>
					<band name="spec3" orientation="H">
					    <bands>
							<band name="spec2" orientation="H">
								<queries>
									<query name="spec2" type="sql">
										<script>
									select  r.name as FED, 
										    count(b.id) AS CHISL,
											(select COALESCE(st.min,0) as RASCHET
									  from benefitstypedir p,
										   benefitsindexdir t,
										   benefitsindexdirhistory ST
                                     where p.rosternumber = 6
                                       and t.benefitstypenamedirid = p.id 
									   and st.benefitsindexdirid = t.id
									   and st.paydatefrom = (select max(xx.paydatefrom) from benefitsindexdirhistory xx where xx.benefitsindexdirid = t.id and (z.repyear||'-'||z.repmonth||'-01')::date >= xx.paydatefrom)) as NORMA,
                                       COALESCE(P.coefficient,0)  AS RCOF,
								 coalesce(SUM((SELECT sum(COALESCE(vv.PAYSUM,0))  
												FROM  BENEFIT06PAYMENT vv 
											   WHERE B.ID = vv.benefit06id
                                                 and vv.coefficient = p.coefficient)),0) AS POSOB
								     from BENEFIT06 B
								INNER JOIN BENEFITSPACKETS Z ON B.benefitspacketsid = Z.ID 
								and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     									and z.repyear = ${repyear}::INTEGER  --входной параметр
								left join BENEFIT06PAYMENT p on p.benefit06id = b.id 		
							    right JOIN subjectsdir R ON Z.subjectsdirID = R.ID
										where r.name = ${spec3.FED}
										group by r.name,P.coefficient,norma
										order by max(r.code);
										</script>
									</query>
								</queries>
							</band>
						</bands>
						<queries>
                            <query name="spec3" type="sql">
                                <script>
								 select fed,(select count(xx.id) from benefit06 xx, BENEFITSPACKETS Z, subjectsdir c  where xx.benefitspacketsid = Z.ID  and c.id = z.subjectsdirid and c.name = tt.fed
								and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     									and z.repyear = ${repyear}::INTEGER) as CHISL, sum(NORMA*RCOF) as RASCHET, sum(POSOB) as POSOB	 	    
						from   (              select r.name as FED, 
										    count(b.id) AS CHISL,
											(select COALESCE(st.min,0) as RASCHET
									  from benefitstypedir p,
										   benefitsindexdir t,
										   benefitsindexdirhistory ST
                                     where p.rosternumber = 6
                                       and t.benefitstypenamedirid = p.id 
									   and st.benefitsindexdirid = t.id
									   and st.paydatefrom = (select max(xx.paydatefrom) from benefitsindexdirhistory xx where xx.benefitsindexdirid = t.id and (z.repyear||'-'||z.repmonth||'-01')::date >= xx.paydatefrom)) as NORMA,
                                       COALESCE(P.coefficient,0)  AS RCOF,
								 coalesce(SUM((SELECT sum(COALESCE(vv.PAYSUM,0))  
												FROM  BENEFIT06PAYMENT vv 
											   WHERE B.ID = vv.benefit06id
                                                 and vv.coefficient = p.coefficient)),0) AS POSOB
								     from BENEFIT06 B
								INNER JOIN BENEFITSPACKETS Z ON B.benefitspacketsid = Z.ID 
								and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     									and z.repyear = ${repyear}::INTEGER  --входной параметр
								left join BENEFIT06PAYMENT p on p.benefit06id = b.id 		
							    right JOIN subjectsdir R ON Z.subjectsdirID = R.ID
										where r.fedreg = ${spec1.FED}
										group by r.name,P.coefficient,b.id,norma
										order by max(r.code)
                                        ) tt
                              group by fed;
                                </script>
                            </query>
                        </queries>
					</band>
				</bands>
                <queries>
                    <query name="spec1" type="sql">
                        <script>
                            			select fedregg as FED, (select count(xx.id) from benefit06 xx, BENEFITSPACKETS Z, subjectsdir c  where xx.benefitspacketsid = Z.ID  and c.id = z.subjectsdirid and c.fedreg = fedregg
								and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     									and z.repyear = ${repyear}::INTEGER) as CHISL,sum(COALESCE(RASCHET,0)) as RASCHET,sum(COALESCE(POSOB,0)) as POSOB
							from(	     select R.fedreg as fedregg,
             					r.name as namess,
             					count(b.id) as CHISL, 
							    count(b.id)*
                                (select COALESCE(st.min,0)
                                from benefitstypedir p,
                                	 benefitsindexdir t,
                                	 benefitsindexdirhistory ST
                               where p.rosternumber = 6
                                and t.benefitstypenamedirid = p.id 
                                and st.benefitsindexdirid = t.id
                                and st.paydatefrom = (select max(xx.paydatefrom) from benefitsindexdirhistory xx where xx.benefitsindexdirid = t.id and (z.repyear||'-'||z.repmonth||'-01')::date >= xx.paydatefrom  ))*
                                COALESCE(P.coefficient,0) AS RASCHET,
								coalesce(SUM((SELECT sum(COALESCE(vv.PAYSUM,0))  
												FROM  BENEFIT06PAYMENT vv 
											   WHERE B.ID = vv.benefit06id
                                                 and vv.coefficient = p.coefficient)),0) AS POSOB,
								(select COALESCE(st.min,0)
                                from benefitstypedir p,
                                	 benefitsindexdir t,
                                	 benefitsindexdirhistory ST
                               where p.rosternumber = 6
                                and t.benefitstypenamedirid = p.id 
                                and st.benefitsindexdirid = t.id
                                and st.paydatefrom = (select max(xx.paydatefrom) from benefitsindexdirhistory xx where xx.benefitsindexdirid = t.id and (z.repyear||'-'||z.repmonth||'-01')::date >= xx.paydatefrom  )) as norma
						     from BENEFIT06 B
					   INNER JOIN BENEFITSPACKETS Z ON B.benefitspacketsid = Z.ID 
					   and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     						and z.repyear = ${repyear}::INTEGER
						left join BENEFIT06PAYMENT p on p.benefit06id = b.id 	
					   right JOIN subjectsdir R ON Z.subjectsdirID = R.ID 
					   --входной параметр
 					--	GROUP BY R.fedreg;
                    GROUP BY r.name,R.fedreg,P.coefficient,norma
					order by max(r.code))  r
                    group by fedregg
					;
                        </script>
                    </query>
                </queries>
            </band>
        </bands>
        <queries/>
    </rootBand>
</report>
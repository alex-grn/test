<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="Areport_benefit01.xls" documentPath="Areport_benefit01.xls" outputType="xls" outputNamePattern="Areport_benefit01.xls"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="Header" orientation="H">
				<queries>
                     <query name="Header" type="sql">
                        <script>
							select 'за '||
									 case ${repmonthby}::integer
									 when 1 then '€нварь'
									 when 2 then 'февраль'
									 when 3 then 'март'
									 when 4 then 'апрель'
									 when 5 then 'май'
									 when 6 then 'июнь'
									 when 7 then 'июль'
									 when 8 then 'август'
									 when 9 then 'сент€брь'
									 when 10 then 'окт€брь'
									 when 11 then 'но€брь'
									 when 12 then 'декабрь'
									 end
									 ||' '||${repyear}::text||' года'  as DATEREPORT;
						</script>
                     </query>
                </queries>
			</band>
			<band name="spec" orientation="H">
				<bands>
					<band name="spec1" orientation="H">
						<queries>
							<query name="spec1" type="sql">
								<script>
										select REGION, NAME_BENEFIT, NUMBER_BENEFIT, FIO, TEL_NUMBER, EMAIL
									from (select ROW_NUMBER() OVER(partition by S.CODE order by S.CODE, XX.ROSTERNUMBER) as BUF,
												S.CODE,
												S.NAME as REGION,
												XX.NAME as NAME_BENEFIT,
												XX.ROSTERNUMBER as NUMBER_BENEFIT,
												(select COALESCE(CC.LASTNAMEPERS, '') || ' ' || COALESCE(CC.FIRSTNAMEPERS, '') || ' ' || COALESCE(CC.PATRONYMICPERS, '')
													from SENDERS UC, COMPANYDIR CC, USERS SS
													where UC.COMPANYNAMEID = CC.ID
													and CC.SUBJECTSDIRID = P.SUBJECTSDIRID
													and UC.USERID = SS.ID
													and SS.DISABLED = false) as FIO,
												(select CC.PHONEPERS
													from SENDERS UC, COMPANYDIR CC, USERS SS
													where UC.COMPANYNAMEID = CC.ID
													and CC.SUBJECTSDIRID = P.SUBJECTSDIRID
													and UC.USERID = SS.ID
													and SS.DISABLED = false) as TEL_NUMBER,
												(select CC.EMAILPERS
													from SENDERS UC, COMPANYDIR CC, USERS SS
													where UC.COMPANYNAMEID = CC.ID
													and CC.SUBJECTSDIRID = P.SUBJECTSDIRID
													and UC.USERID = SS.ID
													and SS.DISABLED = false) as EMAIL
											from BENEFITSTYPEDIR XX, SUBJECTSDIR S
											left join BENEFITSPACKETS P
												on P.SUBJECTSDIRID = S.ID
											and P.REPMONTH ::integer = ${repmonthby}::integer
											and P.REPYEAR = ${repyear}::integer
											left join BENEFICIARIESREGISTERS SP
												on SP.BENEFITSPACKETSID = P.ID
											where not exists (select 1
													from BENEFITSPACKETS H, BENEFICIARIESREGISTERS G
													where G.BENEFITSPACKETSID = H.ID
													and H.REPMONTH ::integer = ${repmonthby}::integer
													and H.REPYEAR = ${repyear}::integer
													and XX.ID = G.BENEFITSTYPENAMEDIRID
													and H.SUBJECTSDIRID = S.ID)
											and S.CODE ::integer != 0
											and XX.ROSTERNUMBER != 7
											group by S.CODE, REGION, NAME_BENEFIT, NUMBER_BENEFIT, FIO, TEL_NUMBER, EMAIL
											order by S.CODE) BUFFER
									where BUFFER.BUF > 1
									  and REGION = ${spec.region};
								</script>
							</query>
						</queries>
					</band>
				</bands>
				<queries>
                     <query name="spec" type="sql">
                        <script>
							select REGION, NAME_BENEFIT, NUMBER_BENEFIT, FIO, TEL_NUMBER, EMAIL
							  from (select ROW_NUMBER() OVER(partition by S.CODE order by S.CODE, XX.ROSTERNUMBER) as BUF,
							  			S.CODE,
							  			S.NAME as REGION,
							  			XX.NAME as NAME_BENEFIT,
							  			XX.ROSTERNUMBER as NUMBER_BENEFIT,
							  			(select COALESCE(CC.LASTNAMEPERS, '') || ' ' || COALESCE(CC.FIRSTNAMEPERS, '') || ' ' || COALESCE(CC.PATRONYMICPERS, '')
							  				from SENDERS UC, COMPANYDIR CC, USERS SS
							  				where UC.COMPANYNAMEID = CC.ID
							  				and CC.SUBJECTSDIRID = P.SUBJECTSDIRID
							  				and UC.USERID = SS.ID
							  				and SS.DISABLED = false) as FIO,
							  			(select CC.PHONEPERS
							  				from SENDERS UC, COMPANYDIR CC, USERS SS
							  				where UC.COMPANYNAMEID = CC.ID
							  				and CC.SUBJECTSDIRID = P.SUBJECTSDIRID
							  				and UC.USERID = SS.ID
							  				and SS.DISABLED = false) as TEL_NUMBER,
							  			(select CC.EMAILPERS
							  				from SENDERS UC, COMPANYDIR CC, USERS SS
							  				where UC.COMPANYNAMEID = CC.ID
							  				and CC.SUBJECTSDIRID = P.SUBJECTSDIRID
							  				and UC.USERID = SS.ID
							  				and SS.DISABLED = false) as EMAIL
							  		from BENEFITSTYPEDIR XX, SUBJECTSDIR S
							  		left join BENEFITSPACKETS P
							  			on P.SUBJECTSDIRID = S.ID
							  		and P.REPMONTH ::integer = ${repmonthby}::integer
							  		and P.REPYEAR = ${repyear}::integer
							  		left join BENEFICIARIESREGISTERS SP
							  			on SP.BENEFITSPACKETSID = P.ID
							  		where not exists (select 1
							  				from BENEFITSPACKETS H, BENEFICIARIESREGISTERS G
							  				where G.BENEFITSPACKETSID = H.ID
							  				and H.REPMONTH ::integer = ${repmonthby}::integer
							  				and H.REPYEAR = ${repyear}::integer
							  				and XX.ID = G.BENEFITSTYPENAMEDIRID
							  				and H.SUBJECTSDIRID = S.ID)
							  		and S.CODE ::integer != 0
									and XX.ROSTERNUMBER != 7
							  		group by S.CODE, REGION, NAME_BENEFIT, NUMBER_BENEFIT, FIO, TEL_NUMBER, EMAIL
							  		order by S.CODE) BUFFER
							  where BUFFER.BUF = 1;
						</script>
                     </query>
                </queries>
			</band>	
			<band name="header2" orientation="H">
				<queries>
                     <query name="header2" type="sql">
                        <script>
							select 'за '||
									 case ${repmonthby}::integer
									 when 1 then '€нварь'
									 when 2 then 'февраль'
									 when 3 then 'март'
									 when 4 then 'апрель'
									 when 5 then 'май'
									 when 6 then 'июнь'
									 when 7 then 'июль'
									 when 8 then 'август'
									 when 9 then 'сент€брь'
									 when 10 then 'окт€брь'
									 when 11 then 'но€брь'
									 when 12 then 'декабрь'
									 end
									 ||' '||${repyear}::text||' года'  as DATEREPORT;
						</script>
                     </query>
                </queries>
			</band>
			<band name="spec3" orientation="H">
				<queries>
                     <query name="spec3" type="sql">
                        <script>
							select reg.name as region, 
								case when (select count(*) from benefit01 s, benefitspackets r where s.benefitspacketsid = r.id and r.repyear = ${repyear}::integer and r.repmonth::integer = ${repmonthby}::integer and r.subjectsdirid = reg.id) > 0    	then '+' else '-' end as benefit01,
								case when (select count(*) from benefit02 s, benefitspackets r where s.benefitspacketsid = r.id and r.repyear = ${repyear}::integer and r.repmonth::integer = ${repmonthby}::integer and r.subjectsdirid = reg.id) > 0    	then '+' else '-' end as benefit02,
								case when (select count(*) from benefit03 s, benefitspackets r where s.benefitspacketsid = r.id and r.repyear = ${repyear}::integer and r.repmonth::integer = ${repmonthby}::integer and r.subjectsdirid = reg.id) > 0    	then '+' else '-' end as benefit03,
								case when (select count(*) from benefit04 s, benefitspackets r where s.benefitspacketsid = r.id and r.repyear = ${repyear}::integer and r.repmonth::integer = ${repmonthby}::integer and r.subjectsdirid = reg.id) > 0    	then '+' else '-' end as benefit04,
								case when (select count(*) from benefit05 s, benefitspackets r where s.benefitspacketsid = r.id and r.repyear = ${repyear}::integer and r.repmonth::integer = ${repmonthby}::integer and r.subjectsdirid = reg.id) > 0    	then '+' else '-' end as benefit05,
								case when (select count(*) from benefit06 s, benefitspackets r where s.benefitspacketsid = r.id and r.repyear = ${repyear}::integer and r.repmonth::integer = ${repmonthby}::integer and r.subjectsdirid = reg.id) > 0    	then '+' else '-' end as benefit06,
								(select COALESCE(c.lastnamepers,'')||' '||COALESCE(c.firstnamepers,'')||' '||COALESCE(c.patronymicpers,'') from SENDERS s, COMPANYDIR c where c.id = s.companynameid and c.subjectsdirid = reg.id limit 1) as fio,  
								(select c.phonepers from SENDERS s, COMPANYDIR c where c.id = s.companynameid and c.subjectsdirid = reg.id limit 1) as tel,
								(select c.emailpers from SENDERS s, COMPANYDIR c where c.id = s.companynameid and c.subjectsdirid = reg.id limit 1) as mail  
							from 
							subjectsdir reg
							order by reg.name;
						</script>
                     </query>
                </queries>
			</band>
        </bands>
        <queries/>
    </rootBand>
</report>
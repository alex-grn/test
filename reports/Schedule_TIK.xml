<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="krf_f_zp_pl_no.xls" documentPath="krf_f_zp_pl_no.xls" outputType="xls" outputNamePattern="krf_f_zp_pl_no.xls"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
			<band name="shedule_head" orientation="H">
				<queries>
                     <query name="shedule_head" type="sql">
                        <script>
							 select tbl.name_choice,
                                     tbl.r_coef,
									 tbl.compensation,
                                     tbl.max_v_coef,
                                     tbl.dop_pay_chairman,
                                     tbl.dop_pay_prchairman,
                                     tbl.dop_pay_secret,
                                     tbl.dop_pay_otherman,
                                     tbl.rod_tik,
                                     tbl.name_ik,
                                     tbl.id_ik,
                                     tbl.num_ik,
                                     tbl.count_ik,
                                     split_part(string_agg(tbl.fio,';'),';',1) as fio1,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',1),''),'0')::numeric as avg_sum1,
                                     split_part(string_agg(tbl.fio,';'),';',2) as fio2,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',2),''),'0')::numeric as avg_sum2,
                                     split_part(string_agg(tbl.fio,';'),';',3) as fio3,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',3),''),'0')::numeric as avg_sum3,
                                     split_part(string_agg(tbl.fio,';'),';',4) as fio4,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',4),''),'0')::numeric as avg_sum4,
                                     split_part(string_agg(tbl.fio,';'),';',5) as fio5,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',5),''),'0')::numeric as avg_sum5,
                                     split_part(string_agg(tbl.fio,';'),';',6) as fio6,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',6),''),'0')::numeric as avg_sum6,
                                     split_part(string_agg(tbl.fio,';'),';',7) as fio7,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',7),''),'0')::numeric as avg_sum7,
                                     split_part(string_agg(tbl.fio,';'),';',8) as fio8,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',8),''),'0')::numeric as avg_sum8,
                                     split_part(string_agg(tbl.fio,';'),';',9) as fio9,  COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',9),''),'0')::numeric as avg_sum9,
                                     split_part(string_agg(tbl.fio,';'),';',10) as fio10,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',10),''),'0')::numeric as avg_sum10,
                                     split_part(string_agg(tbl.fio,';'),';',11) as fio11,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',11),''),'0')::numeric as avg_sum11,
                                     split_part(string_agg(tbl.fio,';'),';',12) as fio12,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',12),''),'0')::numeric as avg_sum12,
                                     split_part(string_agg(tbl.fio,';'),';',13) as fio13,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',13),''),'0')::numeric as avg_sum13,
                                     split_part(string_agg(tbl.fio,';'),';',14) as fio14,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',14),''),'0')::numeric as avg_sum14,
                                     split_part(string_agg(tbl.fio,';'),';',15) as fio15,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',15),''),'0')::numeric as avg_sum15,
                                     split_part(string_agg(tbl.fio,';'),';',16) as fio16,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',16),''),'0')::numeric as avg_sum16,
                                     split_part(string_agg(tbl.fio,';'),';',17) as fio17,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',17),''),'0')::numeric as avg_sum17,
                                     split_part(string_agg(tbl.fio,';'),';',18) as fio18,COALESCE(nullif(split_part(string_agg(tbl.middlesalary::text,';'),';',18),''),'0')::numeric as avg_sum18,
                                     tbl.rod_uik,
                                     tbl.dat_uik,
                                     tbl.tv_uik,
									(select sum(r.enddate-r.begindate+1) from register r where r.id = ANY(P_SYSTEM_GET_SELECTLIST(${idlist}))) as count_w
                                FROM(
                                 select 
                                    e.name as name_choice,
                                    ik.discoefffed as r_coef, --федеральный коэффициент, для региона discoefreg 
									fk.value as compensation,
                                    fn.value as max_v_coef,   --предельный размер коффициента
                                    f1.value as dop_pay_chairman,
                                    f2.value as dop_pay_prchairman,
                                    f3.value as dop_pay_secret,
                                    f4.value as dop_pay_otherman,
                                    case  
                                        when ik.levelelcommittee = 'district' then (select kk.rnameec from ELECTCOMMITTEE kk where kk.idgasecom = ik.idgasparecom)
                                        when ik.levelelcommittee = 'territory' or ik.levelelcommittee = 'circuit' then ik.rnameec 
                                    end as rod_tik,
                                    --r.enddate-r.begindate+1 as count_w,
                                    (select sum((fs.SUMFINTIK+fs.SUMFINTIKCEN+fs.SUMFINUIK)-p_action_finexp_sumpay(f.ID)) from finexp f, TYPEEXP ts, financeelcom fs where f.electcommincampid = el.id and ts.id = f.typeexpid and lower(trim(ts.code)) like '%компенсация%' and fs.TYPEEXPID = f.TYPEEXPID and fs.ELECTCOMMINCAMPID = f.ELECTCOMMINCAMPID) as sum_all_uik,
                                    (select sum((fs.SUMFINTIK+fs.SUMFINTIKCEN+fs.SUMFINUIK)-p_action_finexp_sumpay(f.ID)) from finexp f, TYPEEXP ts, financeelcom fs where f.electcommincampid = el.id and ts.id = f.typeexpid and lower(trim(ts.code)) like '%вознаграждение%' and fs.TYPEEXPID = f.TYPEEXPID and fs.ELECTCOMMINCAMPID = f.ELECTCOMMINCAMPID) as sum_all_uik_dop,
                                    IK.name as name_ik,
                                    IK.CODE AS id_ik,
                                    ik.elecdistnumb as num_ik,
                                    el.countvtr as count_ik,
                                    COALESCE(pp.surname,'')||' '||COALESCE(pp.firstname,'')||' '||COALESCE(pp.middlename,'') as fio,
                                    round(avg(COALESCE(rs.middlesalary,0)),2)::text as middlesalary,
                                    ik.rnameec as rod_uik,
                                    ik.dnameec as dat_uik,
                                    ik.tnameec as tv_uik
                                from register r            --Расчетные документы
                                    inner join registerlist rs on rs.registerid = r.id
                                    inner join committeeman cm on cm.id = rs.committeemanid
                                    inner join person pp on pp.id = cm.personid
                                    inner join posts po on po.id = cm.postsid
                                    inner join electcommincamp el on el.id = r.electcommincampid    --Избирательные комиссии, участвующие в кампании
                                    inner join ELECTCOMMITTEE IK on ik.id = el.electcommitteeid    --Избирательные комиссии
                                    inner join electcampaign e on e.id = r.electcampaignid        --Избирательные кампании
                                    inner join regionsrf reg on reg.id = ik.regionsrfid        --Субъекты Российской Федерации
                                    left join FEDELECCAMP f on f.id = e.fedeleccampid        --Федеральные избирательные кампании
                                    left join NORMSFEDEC fk on fk.fedeleccampid = f.id
                                                            and fk.namenorms = 'limitcomp'  --Предельный размер компенсации за полный месяц работы для региона
                                                            and fk.regionsrfid = reg.id    --Нормы оплаты труда при проведении федеральных выборов (для компенсации)
                                    left join NORMSFEDEC fn on fn.fedeleccampid = f.id
                                                            and fn.namenorms = 'depcoeffmax'  --Предельный размер компенсации за полный месяц работы для региона
                                    left join NORMSFEDEC f1 on f1.fedeleccampid = f.id
                                                            and f1.namenorms = 'reward'  --Предельный размер компенсации за полный месяц работы для региона
                                                            and f1.postsid = (select p.id from posts p where upper(p.postprint) = 'CHAIRMAN' and p.levelelcommittee = COALESCE(nullif(ik.levelelcommittee,'circuit'),'territory'))
                                                            and f1.mcircuit = el.mcircuit
                                    left join NORMSFEDEC f2 on f2.fedeleccampid = f.id
                                                            and f2.namenorms = 'reward'  --Размер дополнительной оплаты труда (вознаграждения) за один час работы в будние дни с 6.00 до 22.00
                                                            and f2.postsid = (select p.id from posts p where upper(p.postprint) = 'DEPCHAIRMAN' and p.levelelcommittee = COALESCE(nullif(ik.levelelcommittee,'circuit'),'territory'))
                                                            and f2.mcircuit = el.mcircuit
                                    left join NORMSFEDEC f3 on  f3.fedeleccampid = f.id
                                                            and f3.namenorms = 'reward'  --Размер дополнительной оплаты труда (вознаграждения) за один час работы в будние дни с 6.00 до 22.00
                                                            and f3.postsid = (select p.id from posts p where upper(p.postprint) = 'SECRETARY' and p.levelelcommittee = COALESCE(nullif(ik.levelelcommittee,'circuit'),'territory'))
                                                            and f3.mcircuit = el.mcircuit
                                    left join NORMSFEDEC f4 on  f4.fedeleccampid = f.id
                                                            and f4.namenorms = 'reward'  --Размер дополнительной оплаты труда (вознаграждения) за один час работы в будние дни с 6.00 до 22.00
                                                            and f4.postsid = (select p.id from posts p where upper(p.postprint) = 'ZOTHERCM' and p.levelelcommittee = COALESCE(nullif(ik.levelelcommittee,'circuit'),'territory'))
                                                            and f4.mcircuit = el.mcircuit
                                where r.id = ANY(P_SYSTEM_GET_SELECTLIST(${idlist}))
                               group by e.name,
                                    ik.discoefffed, --федеральный коэффициент, для региона discoefreg 
									fk.value,
                                    fn.value,   --предельный размер коффициента
                                    f1.value,
                                    f2.value,
                                    f3.value,
                                    f4.value,
                                    case  
                                        when ik.levelelcommittee = 'district' then (select kk.rnameec from ELECTCOMMITTEE kk where kk.idgasecom = ik.idgasparecom)
                                        when ik.levelelcommittee = 'territory' or ik.levelelcommittee = 'circuit' then ik.rnameec 
                                    end ,
                                    (select sum((fs.SUMFINTIK+fs.SUMFINTIKCEN+fs.SUMFINUIK)-p_action_finexp_sumpay(f.ID)) from finexp f, TYPEEXP ts, financeelcom fs where f.electcommincampid = el.id and ts.id = f.typeexpid and lower(trim(ts.code)) like '%компенсация%' and fs.TYPEEXPID = f.TYPEEXPID and fs.ELECTCOMMINCAMPID = f.ELECTCOMMINCAMPID),
                                    (select sum((fs.SUMFINTIK+fs.SUMFINTIKCEN+fs.SUMFINUIK)-p_action_finexp_sumpay(f.ID)) from finexp f, TYPEEXP ts, financeelcom fs where f.electcommincampid = el.id and ts.id = f.typeexpid and lower(trim(ts.code)) like '%вознаграждение%' and fs.TYPEEXPID = f.TYPEEXPID and fs.ELECTCOMMINCAMPID = f.ELECTCOMMINCAMPID),
                                    IK.name,
                                    IK.CODE,
                                    ik.elecdistnumb,
                                    el.countvtr,
                                    ik.rnameec,
                                    ik.dnameec,
                                    ik.tnameec,
                                    COALESCE(pp.surname,'')||' '||COALESCE(pp.firstname,'')||' '||COALESCE(pp.middlename,''),
                                    cm.postbegindate,
                                    po.postprint,
									r.enddate-r.begindate+1
                                order by cm.postbegindate,po.postprint,fio) tbl 
                                group by tbl.name_choice,
                                         tbl.r_coef,
										 tbl.compensation,
                                         tbl.max_v_coef,
                                         tbl.dop_pay_chairman,
                                         tbl.dop_pay_prchairman,
                                         tbl.dop_pay_secret,
                                         tbl.dop_pay_otherman,
                                         tbl.rod_tik,
                                         tbl.name_ik,
                                         tbl.id_ik,
                                         tbl.num_ik,
                                         tbl.count_ik,
                                         tbl.rod_uik,
                                         tbl.dat_uik,
                                         tbl.tv_uik,
										 (select sum(r.enddate-r.begindate+1) from register r where r.id = ANY(P_SYSTEM_GET_SELECTLIST(${idlist})))
								;
						</script>
                     </query>
                </queries>
			</band>
			<band name="shedule_spec1" orientation="H">
				<queries>
                     <query name="shedule_spec1" type="sql">
                        <script>
							     select d2s(tbl.date1) as date1,tbl.type1,wr.countwd as rab
                               FROM( 
                                  select w.datetbl as date1, t.code as type1
                                   from registerlist r
                                        left join worktbl w on w.registerlistid = r.id
                                        left join typeday t on t.id = w.typedayid
                                  where r.registerid = any(p_system_get_selectlist(${idlist}))
                                  group by w.datetbl, t.code
                                  order by w.datetbl) tbl,
                                register r,
                                electcommincamp el,
                                electcampaign c,
                                electcommittee t,
                                WORKCALENDARS wr,
                                DAYSWORKCALENDARS d
                               where r.id = any(p_system_get_selectlist(${idlist}))
                                 and el.id = r.ELECTCOMMINCAMPID
                                 and c.id = el.electcampaignid
                                 and t.id = c.electcommitteeid
                                 and wr.regionsrfid = (select case 
                                                   when (select count(*) from WORKCALENDARS ww where ww.regionsrfid = t.REGIONSRFID) > 1 then 
                                                   t.regionsrfid
                                                   else 
                                                    (select rf.id from regionsrf rf where rf.idgasregionsrf ilike '00')
                                                   end
                                              )
                                 and d.workcalendarsid = wr.id
                                 and d.datewc = tbl.date1
                                group by tbl.date1,tbl.type1,wr.countwd
                                order by tbl.date1
								;
						</script>
                     </query>
                </queries>
			</band>
			<band name="shedule_floor" orientation="H">
				<queries>
                     <query name="shedule_floor" type="sql">
                        <script>
								select
								(select sum((COALESCE(fs.SUMFINTIK,0)+COALESCE(fs.SUMFINTIKCEN,0)+COALESCE(fs.SUMFINUIK,0))-p_action_finexp_sumpay(f.ID)) from finexp f, TYPEEXP ts, financeelcom fs where f.electcommincampid = i.id and ts.id = f.typeexpid and lower(trim(ts.code)) like '%компенсация%' and fs.TYPEEXPID = f.TYPEEXPID and fs.ELECTCOMMINCAMPID = f.ELECTCOMMINCAMPID) as sum_comp,
								(select sum((COALESCE(fs.SUMFINTIK,0)+COALESCE(fs.SUMFINTIKCEN,0)+COALESCE(fs.SUMFINUIK,0))-p_action_finexp_sumpay(f.ID)) from finexp f, TYPEEXP ts, financeelcom fs where f.electcommincampid = i.id and ts.id = f.typeexpid and lower(trim(ts.code)) like '%вознаграждение%' and fs.TYPEEXPID = f.TYPEEXPID and fs.ELECTCOMMINCAMPID = f.ELECTCOMMINCAMPID) as sum_dop
								from register r
								inner join electcampaign el on el.id = r.electcampaignid
								inner join electcommincamp i on i.id = r.electcommincampid
								inner join electcommittee ik on ik.id = i.electcommitteeid 
								left join mfin m on m.electcommitteeid = ik.id and now() >= m.begindate and (m.enddate >=now() or m.enddate is null) and m.mfin::integer in (1,3)
								where r.id = ${id}::bigint
								;
						</script>
                     </query>
                </queries>
			</band>
        </bands>
        <queries/>
    </rootBand>
</report>
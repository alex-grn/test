<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="ags-1.xlsx" documentPath="ags-1.xlsx" outputType="xlsx" outputNamePattern="ags-1.xlsx"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="header" orientation="H">
				<queries>
                     <query name="header" type="sql">
                        <script>
								 select 
											tbl.sreg_all ,         
											tbl.out_org   ,        
											tbl.in_org     ,       
											tbl.timeout     ,     
											tbl.health      ,      
											tbl.family_drama ,     
											tbl.others     ,      
											'—¬≈ƒ≈Õ»ﬂ Œ ◊»—À≈ÕÕŒ—“» √–¿∆ƒ¿Õ, œ–Œ’ŒƒﬂŸ»’'||chr(10)||
											'¿À‹“≈–Õ¿“»¬Õ”ﬁ √–¿∆ƒ¿Õ— ”ﬁ —À”∆¡”'||chr(10)||
											case ${percalc} when '1' then 'Á‡ ÙÂ‚‡Î¸ '|| ${yearcalc}||' „. - Ë˛Î¸ '|| ${yearcalc}||' „.'
											when '2' then 'Á‡ ‡‚„ÛÒÚ '|| ${yearcalc}||' „. - ˇÌ‚‡¸ '|| (${yearcalc}::integer+1)::text ||' „.'  
											end as doca
									from (select sum(re.person_on) as sreg_all,
												 sum(re.permanent_residents_not_rus) as out_org,
												 sum(re.permanent_residents_rus) as in_org,
												 sum(re.end_service) as timeout,
												 sum(re.health) as health,
												 sum(re.circumstances_family) as family_drama,
												 sum(re.circumstances_others) as others
											from CALCTABAGS CTA,
											     REGAGS re,
												 regiondir rd
										   where re.calctabagsid = cta.id
											 and cta.percalc = ${percalc}
											 and cta.yearcalc = ${yearcalc}::integer
											 and re.regiondirid = rd.id) tbl
   							   ;
						</script>
                     </query>
                </queries>
			</band>
			<band name="spec_f" orientation="H">
				<bands>
					<band name="spec_s" orientation="H">
						<queries>
							<query name="spec_s" type="sql">
								<script>
									select rd.sorting,
										   rd.name as name_s,
										   sum(re.person_on) as sreg_all,
										   sum(re.permanent_residents_not_rus) as out_org,
										   sum(re.permanent_residents_rus) as in_org,
										   sum(re.end_service) as timeout,
										   sum(re.health) as health,
										   sum(re.circumstances_family) as family_drama,
										   sum(re.circumstances_others) as others
									  from CALCTABAGS CTA,
										   REGAGS re,
										   regiondir rd
									 where re.calctabagsid = cta.id
									   and cta.percalc = ${percalc}
									   and cta.yearcalc = ${yearcalc}::integer
									   and re.regiondirid = rd.id
									   and rd.districtfederal::bigint = ${spec_f.id}
									 group by rd.sorting, rd.name
									 order by rd.sorting;
								</script>
							</query>
						</queries>
					</band>
				</bands>
				<queries>
                     <query name="spec_f" type="sql">
                        <script>
							select case fo.id
									 when 3 then 2
									 when 2 then 3
								   else
									 fo.id
								   end id,
								   fo.name as name_f,
								   sum(re.person_on) as sreg_all,
								   sum(re.permanent_residents_not_rus) as out_org,
								   sum(re.permanent_residents_rus) as in_org,
								   sum(re.end_service) as timeout,
								   sum(re.health) as health,
								   sum(re.circumstances_family) as family_drama,
								   sum(re.circumstances_others) as others
							  from CALCTABAGS CTA,
								   REGAGS re,
								   regiondir rd,
								   (select cast(mp.code as bigint) as id, t.hid,t.lid,t.cid,t.uid,t.tim,mp.name, t.id as calctabagsid from (select * from calctabags limit 1) t, metaclass m, metaclass mp where m.code='DISTRICTFEDERAL' and m.id = mp.hid and mp.classnode='AI') fo
							 where re.calctabagsid = cta.id
							   and cta.percalc = ${percalc}
							   and cta.yearcalc = ${yearcalc}::integer
							   and re.regiondirid = rd.id
							   and rd.districtfederal::bigint = fo.id
							 group by case fo.id
										when 3 then 2
										when 2 then 3
									  else
										fo.id
									  end, fo.name
							 order by case fo.id
										when 3 then 2
										when 2 then 3
									  else
										fo.id
									  end;
						</script>
                     </query>
                </queries>
			</band>
			<band name="floor" orientation="H">
				<queries>
                     <query name="floor" type="sql">
                        <script>
						     select 
								'"    " '||case ${percalc} when '1' then 'ÙÂ‚‡Î¸' when '2' then '‡‚„ÛÒÚ' end||' '||${yearcalc}||' „Ó‰‡' as dates,
								(select sum(re.educ_bgn_gen_prev) + sum(re.educ_bgn_gen)           from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '0') as beg_ed1, 
								(select sum(re.educ_main_gen_prev) + sum(re.educ_main_gen)         from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '0') as osn_ed1, 
								(select sum(re.educ_mdl_full_gen_prev) + sum(re.educ_mdl_full_gen) from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '0') as mid_ed1, 
								(select sum(re.educ_bgn_prof_prev) + sum(re.educ_bgn_prof) 	   	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '0') as beg_pr1, 
								(select sum(re.educ_mdl_prof_prev) + sum(re.educ_mdl_prof)     	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '0') as mid_pr1, 
								(select sum(re.educ_hgh_prof_prev) + sum(re.educ_hgh_prof)    	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '0') as up_pr1,
								
								(select sum(re.educ_bgn_gen_prev) + sum(re.educ_bgn_gen)           from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '1') as beg_ed2, 
								(select sum(re.educ_main_gen_prev) + sum(re.educ_main_gen)         from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '1') as osn_ed2, 
								(select sum(re.educ_mdl_full_gen_prev) + sum(re.educ_mdl_full_gen) from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '1') as mid_ed2, 
								(select sum(re.educ_bgn_prof_prev) + sum(re.educ_bgn_prof) 	   	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '1') as beg_pr2, 
								(select sum(re.educ_mdl_prof_prev) + sum(re.educ_mdl_prof)     	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '1') as mid_pr2, 
								(select sum(re.educ_hgh_prof_prev) + sum(re.educ_hgh_prof)    	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '1') as up_pr2,
								
								(select sum(re.educ_bgn_gen_prev) + sum(re.educ_bgn_gen)           from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '2') as beg_ed3, 
								(select sum(re.educ_main_gen_prev) + sum(re.educ_main_gen)         from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '2') as osn_ed3, 
								(select sum(re.educ_mdl_full_gen_prev) + sum(re.educ_mdl_full_gen) from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '2') as mid_ed3, 
								(select sum(re.educ_bgn_prof_prev) + sum(re.educ_bgn_prof) 	   	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '2') as beg_pr3, 
								(select sum(re.educ_mdl_prof_prev) + sum(re.educ_mdl_prof)     	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '2') as mid_pr3, 
								(select sum(re.educ_hgh_prof_prev) + sum(re.educ_hgh_prof)    	   from CALCTABAGS CTA, REGAGSEDUC re where re.calctabagsid = cta.id and cta.percalc = ${percalc} and cta.yearcalc = ${yearcalc}::integer and re.educage = '2') as up_pr3;
						</script>
                     </query>
                </queries>
			</band>
        </bands>
        <queries/>
    </rootBand>
</report>
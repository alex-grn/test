<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="ags-1.xlsx" documentPath="ags-1.xlsx" outputType="xlsx" outputNamePattern="ags-1.xlsx"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="header" orientation="H">
				<queries>
                     <query name="header" type="sql">
                        <script>
								 select 
											tbl.sreg_all ,         
											tbl.in_org_all  ,    
											tbl.out_org   ,        
											tbl.in_org     ,       
											tbl.fire_ags   ,      
											tbl.timeout     ,     
											tbl.health      ,      
											tbl.family_drama ,     
											tbl.others     ,      
											tbl.sreg_all + tbl.in_org_all - tbl.fire_ags as ends,
											'СВЕДЕНИЯ О ЧИСЛЕННОСТИ ГРАЖДАН, ПРОХОДЯЩИХ'||chr(10)||
											'АЛЬТЕРНАТИВНУЮ ГРАЖДАНСКУЮ СЛУЖБУ'||chr(10)||
											case ${dateofrequest} when '1' then 'за февраль '|| ${yearconscription}||' г. - июль '|| ${yearconscription}||' г.'
											when '2' then 'за август '|| ${yearconscription}||' г. - январь '|| (${yearconscription}::integer+1)::text ||' г.'  
											end as doca
									from (  select    
											(select count(s.id)  
												from citizenry s, 
													regiondir r,
													EDUCATIONCIT e 
											where r.id = s.regiondirid 
											and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
											and s.conscription = ${dateofrequest}
											and s.yearconscription = ${yearconscription}::integer 
											and s.statuscitizen = '3'
											and e.citizenryid = s.id
											and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
											and e.leveleducation in ('2','3','4','5','6','8')) as sreg_all,
											-- в организации всего
											(select count(s.id)   
												from citizenry s, 
													regiondir r, 
													DIRECTION p,
													ORGANIZATION o,
													ORGANIZATIONDIR org,
													EDUCATIONCIT e 
											where r.id = s.regiondirid 
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
											and s.conscription = ${dateofrequest} 
											and s.yearconscription = ${yearconscription}::integer 
											and p.citizenryid = s.id
											and o.id = p.organizationid
											and org.id = o.organizationdirid
											and org.regiondirid is not null
											and s.statuscitizen = '3'
											and e.citizenryid = s.id
											and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
											and e.leveleducation in ('2','3','4','5','6','8')) as in_org_all,
											-- в другом местоположении
											(select count(s.id) 
											from citizenry s, 
												regiondir r,
												DIRECTION p,
												ORGANIZATION o,
												ORGANIZATIONDIR org,
												EDUCATIONCIT e
											where r.id = s.regiondirid
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
												and s.conscription = ${dateofrequest} 
												and s.yearconscription = ${yearconscription}::integer 
												and p.citizenryid = s.id 
												and o.id = p.organizationid
												and org.id = o.organizationdirid
												and s.statuscitizen = '3'
												and org.regiondirid != s.regiondirid
												and e.citizenryid = s.id
												and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
												and e.leveleducation in ('2','3','4','5','6','8')) as out_org,
											-- в своем местоположении
											(select count(s.id)
											from citizenry s,  
												regiondir r,
												DIRECTION p,
												ORGANIZATION o,
												ORGANIZATIONDIR org,
												EDUCATIONCIT e
											where r.id = s.regiondirid
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
												and s.conscription = ${dateofrequest} 
												and s.yearconscription = ${yearconscription}::integer 
												and p.citizenryid = s.id 
												and o.id = p.organizationid
												and org.id = o.organizationdirid
												and s.statuscitizen = '3'
												and org.regiondirid = s.regiondirid
												and e.citizenryid = s.id
												and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
												and e.leveleducation in ('2','3','4','5','6','8')) as in_org,
											-- все уволенные
											(select count(s.id)
												from citizenry s, 
													regiondir r,
													PASSAGEAGSCIT p,
													EDUCATIONCIT e
											where r.id = s.regiondirid
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
												and s.conscription = ${dateofrequest} 
												and s.yearconscription = ${yearconscription}::integer 
												and p.citizenryid = s.id 
												and p.DATEOFDISMISSLA is not null
												and p.basis4 in ('1','2','5','6')
												and s.statuscitizen = '4'
												and e.citizenryid = s.id
												and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
												and e.leveleducation in ('2','3','4','5','6','8')
											limit 1) as fire_ags,
											-- уволенный по истечении срока альтернативной гражданской службы
											(select count(s.id)
												from citizenry s, 
													regiondir r,
													PASSAGEAGSCIT p,
													EDUCATIONCIT e
											where r.id = s.regiondirid
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
												and s.conscription = ${dateofrequest} 
												and s.yearconscription = ${yearconscription}::integer 
												and p.citizenryid = s.id 
												and p.DATEOFDISMISSLA is not null
												and p.basis4 = '1'
												and s.statuscitizen = '4'
												and e.citizenryid = s.id
												and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
												and e.leveleducation in ('2','3','4','5','6','8')
											limit 1) as timeout,
											-- уволенный по состоянию здоровья
											(select count(s.id)
												from citizenry s, 
													regiondir r,
													PASSAGEAGSCIT p,
													EDUCATIONCIT e
											where r.id = s.regiondirid
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
												and s.conscription = ${dateofrequest} 
												and s.yearconscription = ${yearconscription}::integer 
												and p.citizenryid = s.id 
												and p.DATEOFDISMISSLA is not null
												and p.basis4 = '2'
												and s.statuscitizen = '4'
												and e.citizenryid = s.id
												and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
												and e.leveleducation in ('2','3','4','5','6','8')
											limit 1) as health,
											-- уволенный по семейным обстоятельствам
											(select count(s.id)
												from citizenry s, 
													regiondir r,
													PASSAGEAGSCIT p,
													EDUCATIONCIT e
											where r.id = s.regiondirid
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
												and s.conscription = ${dateofrequest} 
												and s.yearconscription = ${yearconscription}::integer 
												and p.citizenryid = s.id 
												and p.DATEOFDISMISSLA is not null
												and p.basis4 = '5'
												and s.statuscitizen = '4'
												and e.citizenryid = s.id
												and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
												and e.leveleducation in ('2','3','4','5','6','8')
											limit 1) as family_drama,
											-- уволенный по иным обстоятельствам
											(select count(s.id)
												from citizenry s, 
													regiondir r,
													PASSAGEAGSCIT p,
													EDUCATIONCIT e
											where r.id = s.regiondirid
												and split_part(age(now(),s.birthdate)::text,' ',1)::integer>=18
												and s.conscription = ${dateofrequest} 
												and s.yearconscription = ${yearconscription}::integer 
												and p.citizenryid = s.id 
												and p.DATEOFDISMISSLA is not null
												and p.basis4 = '6'
												and s.statuscitizen = '4'
												and e.citizenryid = s.id
												and e.hidedate = (select max(x.hidedate) from EDUCATIONCIT x where x.citizenryid = e.citizenryid)
												and e.leveleducation in ('2','3','4','5','6','8')
											limit 1) as others) tbl
   							   ;
						</script>
                     </query>
                </queries>
			</band>
			<band name="spec_f" orientation="H">
				<bands>
					<band name="spec_s" orientation="H">
						<queries>
							<query name="spec_s" type="sql">
								<script>
									select r.names as name_s,
										r.reg_all as sreg_all,
										r.in_org_all,
										r.out_org,
										r.in_org,
										r.fire_ags,
										r.timeout,
										r.health,
										r.family_drama,
										r.others,
										r.ends
									from report_1ags r
									where r.names is not null and r.fnames is not null
									and r.ident = ${ident}::bigint
									and r.fnames = ${spec_f.name_f}
								;
								</script>
							</query>
						</queries>
					</band>
				</bands>
				<queries>
                     <query name="spec_f" type="sql">
                        <script>
							select r.fnames as name_f,
								r.reg_all as sreg_all,
								r.in_org_all,
								r.out_org,
								r.in_org,
								r.fire_ags,
								r.timeout,
								r.health,
								r.family_drama,
								r.others,
								r.ends
							from report_1ags r
							where r.names is null and r.fnames is not null
							and r.ident = ${ident}::bigint
   							   ;
						</script>
                     </query>
                </queries>
			</band>
			<band name="floor" orientation="H">
				<queries>
                     <query name="floor" type="sql">
                        <script>
						     select 
								'"    " '||case ${dateofrequest} when '1' then 'февраль' when '2' then 'август' end||' '||${yearconscription}||' года' as dates,
								(select reg_all from report_1ags r where r.fnames is null and r.sort = 1) as all_humans,
								(select in_org_all from report_1ags r where r.fnames is null and r.sort = 1) as beg_ed, 
								(select out_org from report_1ags r where r.fnames is null and r.sort = 1) as osn_ed, 
								(select in_org from report_1ags r where r.fnames is null and r.sort = 1) as mid_ed, 
								(select fire_ags from report_1ags r where r.fnames is null and r.sort = 1) as beg_pr, 
								(select timeout from report_1ags r where r.fnames is null and r.sort = 1) as mid_pr, 
								(select health from report_1ags r where r.fnames is null and r.sort = 1) as up_pr,
								
								(select reg_all from report_1ags r where r.fnames is null and r.sort = 2) as all_humans1,
								(select in_org_all from report_1ags r where r.fnames is null and r.sort = 2) as beg_ed1, 
								(select out_org from report_1ags r where r.fnames is null and r.sort = 2) as osn_ed1, 
								(select in_org from report_1ags r where r.fnames is null and r.sort = 2) as mid_ed1, 
								(select fire_ags from report_1ags r where r.fnames is null and r.sort = 2) as beg_pr1, 
								(select timeout from report_1ags r where r.fnames is null and r.sort = 2) as mid_pr1, 
								(select health from report_1ags r where r.fnames is null and r.sort = 2) as up_pr1,
								
								(select reg_all from report_1ags r where r.fnames is null and r.sort = 3) as all_humans2,
								(select in_org_all from report_1ags r where r.fnames is null and r.sort = 3) as beg_ed2, 
								(select out_org from report_1ags r where r.fnames is null and r.sort = 3) as osn_ed2, 
								(select in_org from report_1ags r where r.fnames is null and r.sort = 3) as mid_ed2, 
								(select fire_ags from report_1ags r where r.fnames is null and r.sort = 3) as beg_pr2, 
								(select timeout from report_1ags r where r.fnames is null and r.sort = 3) as mid_pr2, 
								(select health from report_1ags r where r.fnames is null and r.sort = 3) as up_pr2,
								
								(select reg_all from report_1ags r where r.fnames is null and r.sort = 4) as all_humans3,
								(select in_org_all from report_1ags r where r.fnames is null and r.sort = 4) as beg_ed3, 
								(select out_org from report_1ags r where r.fnames is null and r.sort = 4) as osn_ed3, 
								(select in_org from report_1ags r where r.fnames is null and r.sort = 4) as mid_ed3, 
								(select fire_ags from report_1ags r where r.fnames is null and r.sort = 4) as beg_pr3, 
								(select timeout from report_1ags r where r.fnames is null and r.sort = 4) as mid_pr3, 
								(select health from report_1ags r where r.fnames is null and r.sort = 4) as up_pr3
								   
								 
   							   ;
						</script>
                     </query>
                </queries>
			</band>
        </bands>
        <queries/>
    </rootBand>
</report>
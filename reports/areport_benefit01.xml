<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="Areport_benefit01.xls" documentPath="Areport_benefit01.xls" outputType="xls" outputNamePattern="Areport_benefit01.xls"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="Header" orientation="H">
				<queries>
                     <query name="Header" type="sql">
                        <script>
							select 'за период с '||
									case ${repmonth}::integer
									 when 1 then '€нвар€'
									 when 2 then 'феврал€'
									 when 3 then 'марта'
									 when 4 then 'апрел€'
									 when 5 then 'ма€'
									 when 6 then 'июн€'
									 when 7 then 'июл€'
									 when 8 then 'августа'
									 when 9 then 'сент€бр€'
									 when 10 then 'окт€бр€'
									 when 11 then 'но€бр€'
									 when 12 then 'декабр€'
									 end
									 ||' по '||
									 case ${repmonthby}::integer
									 when 1 then '€нварь'
									 when 2 then 'февраль'
									 when 3 then 'март'
									 when 4 then 'апрель'
									 when 5 then 'май'
									 when 6 then 'июнь'
									 when 7 then 'июль'
									 when 8 then 'август'
									 when 9 then 'сент€брь'
									 when 10 then 'окт€брь'
									 when 11 then 'но€брь'
									 when 12 then 'декабрь'
									 end
									 ||' '||${repyear}::text||' года'  as DATEREPORT
						</script>
                     </query>
                </queries>
			</band>		
			<band name="spec2" orientation="H">
				<queries>
                    <query name="spec2" type="sql">
                        <script>
                            select 'ќбщий итог:' as SUBJECTSDIR_1, 
							coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid) 
                                   FROM BENEFITCHILD DD ,
                                   		CHILD D
                                   WHERE DD.ID = D.benefitchildid 
                                   AND DD.benefitchildumber = 1
                                   and B.ID = D.benefit01id
                                   group by d.benefit01id)),0) AS CHILDUMBERVIRT1_1,
								coalesce(SUM((SELECT sum(COALESCE(P.PAYSUM,0))  
												FROM BENEFITCHILD DD,  
													 benefit01payment p,
                                   		CHILD D 
											   WHERE DD.ID = D.benefitchildid
												 AND B.ID = P.benefit01id 
												 AND P.child01id = D.ID
												 AND DD.benefitchildumber = 1
                                                 and B.ID = D.benefit01id
                                                 group by d.benefit01id)),0) +
								coalesce(SUM((SELECT sum(COALESCE(P.PAYSUM,0))  
										       FROM BENEFITCHILD DD,  
													benefit01payment p,
                                   		CHILD D 
										      WHERE DD.ID = D.benefitchildid
												AND B.ID = P.benefit01id 
												AND P.child01id = D.ID
												AND DD.benefitchildumber >= 2
                                                and B.ID = D.benefit01id
                                                group by d.benefit01id)),0) AS benefits_paid1,				 
								   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid) 
										  FROM BENEFITCHILD DD,
                                   		CHILD D 
										 WHERE DD.ID = D.benefitchildid 
										   AND DD.benefitchildumber >= 2
                                           and B.ID = D.benefit01id
                                           group by d.benefit01id)),0) AS CHILDUMBERVIRT2_1,
								
                                   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid)
										  FROM BENEFITCHILD DD,
                                   			   CHILD D 
										 WHERE DD.ID = D.benefitchildid
                                         and B.ID = D.benefit01id 
                                        group by d.benefit01id)),0) AS SUMMA
						     from subjectsdir r
							left JOIN BENEFITSPACKETS Z ON r.id = Z.subjectsdirid
							and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     						and z.repyear = ${repyear}::INTEGER
							left join BENEFIT01 B on b.benefitspacketsid = z.id;
                        </script>
                    </query>
                </queries>
            </band>
            <band name="spec" orientation="H">
				<bands>
					<band name="spec1" orientation="H">
						<queries>
                            <query name="spec1" type="sql">
                                <script>
									select r.name as SUBJECTSDIR1,  
								   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid) 
                                   FROM BENEFITCHILD DD ,
                                   		CHILD D
                                   WHERE DD.ID = D.benefitchildid 
                                   AND DD.benefitchildumber = 1
                                   and B.ID = D.benefit01id
                                   group by d.benefit01id)),0) AS CHILDUMBERVIRT11,
								coalesce(SUM((SELECT sum(COALESCE(P.PAYSUM,0))  
												FROM BENEFITCHILD DD,  
													 benefit01payment p,
                                   		CHILD D 
											   WHERE DD.ID = D.benefitchildid
												 AND B.ID = P.benefit01id 
												 AND P.child01id = D.ID
												 AND DD.benefitchildumber = 1
                                                 and B.ID = D.benefit01id
                                                 group by d.benefit01id)),0)+
									coalesce(SUM((SELECT sum(COALESCE(P.PAYSUM,0))  
										       FROM BENEFITCHILD DD,  
													benefit01payment p,
                                   		CHILD D 
										      WHERE DD.ID = D.benefitchildid
												AND B.ID = P.benefit01id 
												AND P.child01id = D.ID
												AND DD.benefitchildumber >= 2
                                                and B.ID = D.benefit01id
                                                group by d.benefit01id)),0) AS benefits_paid1,			 
								   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid) 
										  FROM BENEFITCHILD DD,
                                   		CHILD D 
										 WHERE DD.ID = D.benefitchildid 
										   AND DD.benefitchildumber >= 2
                                           and B.ID = D.benefit01id
                                           group by d.benefit01id)),0) AS CHILDUMBERVIRT21,
								
                                   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid) 
										  FROM BENEFITCHILD DD,
                                   			   CHILD D 
										 WHERE DD.ID = D.benefitchildid
                                         and B.ID = D.benefit01id 
                                        group by d.benefit01id)),0) AS SUMMA
						     from subjectsdir r
							left JOIN BENEFITSPACKETS Z ON r.id = Z.subjectsdirid 
							and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     						and z.repyear = ${repyear}::INTEGER
							left join BENEFIT01 B on b.benefitspacketsid = z.id
										where r.fedreg = ${spec.subjectsdir}
										group by r.name;
                                </script>
                            </query>
                        </queries>
					</band>
				</bands>
                <queries>
                    <query name="spec" type="sql">
                        <script>
						select r.fedreg as SUBJECTSDIR, 
								   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid) 
                                   FROM BENEFITCHILD DD ,
                                   		CHILD D
                                   WHERE DD.ID = D.benefitchildid 
                                   AND DD.benefitchildumber = 1
                                   and B.ID = D.benefit01id
                                   group by d.benefit01id)),0) AS CHILDUMBERVIRT1,
								coalesce(SUM((SELECT sum(COALESCE(P.PAYSUM,0))  
												FROM BENEFITCHILD DD,  
													 benefit01payment p,
                                   		CHILD D 
											   WHERE DD.ID = D.benefitchildid
												 AND B.ID = P.benefit01id 
												 AND P.child01id = D.ID
												 AND DD.benefitchildumber = 1
                                                 and B.ID = D.benefit01id
                                                 group by d.benefit01id)),0)+
									coalesce(SUM((SELECT sum(COALESCE(P.PAYSUM,0))  
										       FROM BENEFITCHILD DD,  
													benefit01payment p,
                                   		CHILD D 
										      WHERE DD.ID = D.benefitchildid
												AND B.ID = P.benefit01id 
												AND P.child01id = D.ID
												AND DD.benefitchildumber >= 2
                                                and B.ID = D.benefit01id
                                                group by d.benefit01id)),0) AS benefits_paid1,			 
								   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid) 
										  FROM BENEFITCHILD DD,
                                   		CHILD D 
										 WHERE DD.ID = D.benefitchildid 
										   AND DD.benefitchildumber >= 2
                                           and B.ID = D.benefit01id
                                           group by d.benefit01id)),0) AS CHILDUMBERVIRT2,
								
                                   coalesce(SUM((SELECT COUNT(DISTINCT dd.benefitsrecipientsid)
										  FROM BENEFITCHILD DD,
                                   			   CHILD D 
										 WHERE DD.ID = D.benefitchildid
                                         and B.ID = D.benefit01id 
                                        group by d.benefit01id)),0) AS SUMMA 
						     from subjectsdir r
							left JOIN BENEFITSPACKETS Z ON r.id = Z.subjectsdirid 
							and Z.repmonth::integer between ${repmonth}::integer and ${repmonthby}::integer
     						and z.repyear = ${repyear}::INTEGER
					left join BENEFIT01 B on b.benefitspacketsid = z.id
 						GROUP BY R.fedreg;
                        </script>
                    </query>
                </queries>
            </band>
        </bands>
        <queries/>
    </rootBand>
</report>
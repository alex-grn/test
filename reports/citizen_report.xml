<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="citizen_report.xls" documentPath="citizen_report.xls" outputType="xls" outputNamePattern="citizen_report.xls"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="Header" orientation="H">
				<queries>
                     <query name="Header" type="sql">
                        <script>
							select 1::text  as HEADREPORT
						</script>
                     </query>
                </queries>
			</band>
		    <band name="detail" orientation="H">
				<queries>
                     <query name="detail" type="sql">
                        <script>
							select COALESCE(g.lastname,'')||' '||COALESCE(g.firstname,'')||' '||COALESCE(g.patronymic,'') as fio,
								case g.CONSCRIPTION 
									when '1' then 'Весна'
									when '2' then 'Осень'
								end||' '|| g.YEARCONSCRIPTION as period_year,
								dr.name as reg_out,
								r.name as reg_in,
								ep.name as post_educ,
								case g.beliefs
									when '1' then 'Адвентист 7 дня'
									when '2' then 'Баптист'
									when '3' then 'Ислам'
									when '4' then 'Пацифист'
									when '5' then 'Пятидесятник'
									when '6' then 'Свидетели Иеговы'
									when '7' then 'Старовер'
									when '8' then 'Другое'
								end as beliefs,
								case g.statuscitizen
									when '1' then 'Зарегистрирован'
									when '2' then 'Утвержден'
									when '3' then 'Проходит АГС'
									when '4' then 'Уволен со службы'
									when '5' then 'Отказ'
									when '6' then 'Повторное распределение'
									when '7' then 'Направлен на АГС'
									when '8' then 'Редактирование'
								end as statuscitizen,
								dp.name as departmentdir,
								dos.name as organizationdir,
								vp.name as post_vac
									
								
							from CITIZENRY g
							--регион призыва
							left join REGIONDIR r on r.id = g.regiondirid 
							--план заданий гражданина
							left join DIRECTION d on d.citizenryid = g.id
							left join ORGANIZATION o on o.id = d.organizationid
							left join ORGANIZATIONDIR dos on dos.id = o.organizationdirid
							--берем регион направления из плана заданий
							left join REGIONDIR dr on dr.id = dos.regiondirid
							--берем ведомство из плана заданий
							left join DEPARTMENTDIR dp on dp.id = dos.departmentdirid 
							--берем вакансию из плана заданий
							left join VACANCYORG v on v.id = d.vacancyorgid
							left join PROFESSIONDIR vp on vp.id = v.professiondirid
							--образование
							left join EDUCATIONCIT e on e.citizenryid = g.id and e.hidedate = (select max(ed.hidedate) from EDUCATIONCIT ed where ed.citizenryid = e.citizenryid)
							left join PROFESSIONDIR ep on ep.id = e.professiondirid 
							--
							where (dp.id::text = ${departmentdirid} or ${departmentdirid} is null or ${departmentdirid} = '')
							and (r.id::text = ${regiondirid} or ${regiondirid} is null or ${regiondirid} = '')
							and (dr.id::text = ${regiondir2id} or ${regiondir2id} is null or ${regiondir2id} = '')
							and (g.statuscitizen = ${statuscitizen} or ${statuscitizen} is null or ${statuscitizen} = '')
							and (g.CONSCRIPTION = ${conscription} or ${conscription} is null or ${conscription} = '')
							and (g.YEARCONSCRIPTION::text = ${yearconscription} or ${yearconscription} is null or ${yearconscription} = '')
							and (g.BELIEFS = ${beliefs} or ${beliefs} is null or ${beliefs} = '')
							order by fio
						</script>
                     </query>
                </queries>
			</band>
        </bands>
        <queries/>
    </rootBand>
</report>
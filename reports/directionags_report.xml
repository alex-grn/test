<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="directionags_report.xls" documentPath="directionags_report.xls" outputType="xls" outputNamePattern="directionags_report.xls"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="Header" orientation="H">
				<queries>
                     <query name="Header" type="sql">
                        <script>
							select 1::text  as HEADREPORT
						</script>
                     </query>
                </queries>
			</band>
		    <band name="persdata" orientation="H">
				<queries>
                     <query name="persdata" type="sql">
                        <script>
							select case when trim(C.lastname) is not null then trim(C.lastname) else '' end ||' '||
								   case when trim(C.firstname) is not null then trim(C.firstname) else '' end ||' '||
								   case when trim(C.patronymic) is not null then trim(C.patronymic) else '' end as fio,
								   C.numberc,
								   RD.name as reg_name,
								   C.enlistment,
								   case C.statuscitizen
								     when '1' then
									   'Зарегистрирован'
								     when '2' then
									   'Утвержден'
								     when '3' then
									   'Проходит АГС'
								     when '4' then
									   'Уволен со службы'
								     when '5' then
									   'Отказ'
									 when '6' then
									   'Повторное распределение'
								     when '7' then
									   'Направлен на АГС'
								     when '10' then
									   'Редактирование'
								   else
									 'Не определено!'
								   end as status
								   
								   /*case D.status
								     when '1' then
									   'Проект'
								     when '2' then
									   'Отклонено'
								     when '3' then
									   'Утверждено'
								     when '4' then
									   'Подтверждено'
								     when '5' then
									   'Подбор'
								   else
									 'Не определено!'
								   end as status*/
							  from CITIZENRY                C
								   left join REGIONDIR	   RD on RD.ID = C.regiondirid
								   left join PLANS 		    P on P.id = C.plansid
							 where 
							 <!-- только направлен на АГС -->
							 ((${statuscitizen} = '' or ${statuscitizen} is null) or C.statuscitizen = ${statuscitizen})
							 <!-- Год призыва -->
							 and ((${yearconscription} = '' or ${yearconscription} is null) or P.yearconscription = ${yearconscription}::integer)
							 <!-- Период призыва -->
							 and ((${conscription} = '' or ${conscription} is null) or P.conscription = ${conscription})
							 <!-- Военкомат -->
							 and ((${enlistment} = '' or ${enlistment} is null) or p_tools_strinlike(C.enlistment, ${enlistment}) = 1)
							 <!-- Регион -->
							 and ((${regiondirid} = '' or ${regiondirid} is null) or C.regiondirid = ${regiondirid}::bigint)
						</script>
                     </query>
                </queries>
			</band>
		    <band name="persfull" orientation="H">
				<queries>
                     <query name="persfull" type="sql">
                        <script>
							select count(1) as cnt_pers_full
							  from CITIZENRY                C
								   left join REGIONDIR	   RD on RD.ID = C.regiondirid
								   left join PLANS 		    P on P.id = C.plansid
							 where 
							 <!-- ВСЕ -->
							 ((${statuscitizen} = '' or ${statuscitizen} is null) or C.statuscitizen = ${statuscitizen})
							 <!-- Год призыва -->
							 and ((${yearconscription} = '' or ${yearconscription} is null) or P.yearconscription = ${yearconscription}::integer)
							 <!-- Период призыва -->
							 and ((${conscription} = '' or ${conscription} is null) or P.conscription = ${conscription})
							 <!-- Военкомат -->
							 and ((${enlistment} = '' or ${enlistment} is null) or p_tools_strinlike(C.enlistment, ${enlistment}) = 1)
							 <!-- Регион -->
							 and ((${regiondirid} = '' or ${regiondirid} is null) or C.regiondirid = ${regiondirid}::bigint)
						</script>
                     </query>
                </queries>
			</band>
		    <band name="perssend" orientation="H">
				<queries>
                     <query name="perssend" type="sql">
                        <script>
							select count(1) cnt_pers_send
							  from CITIZENRY                C
								   left join REGIONDIR	   RD on RD.ID = C.regiondirid
								   left join PLANS 		    P on P.id = C.plansid
							 where 
							 <!-- только направлен на АГС -->
							 C.statuscitizen = '7'--'6'
							 <!-- Год призыва -->
							 and ((${yearconscription} = '' or ${yearconscription} is null) or P.yearconscription = ${yearconscription}::integer)
							 <!-- Период призыва -->
							 and ((${conscription} = '' or ${conscription} is null) or P.conscription = ${conscription})
							 <!-- Военкомат -->
							 and ((${enlistment} = '' or ${enlistment} is null) or p_tools_strinlike(C.enlistment, ${enlistment}) = 1)
							 <!-- Регион -->
							 and ((${regiondirid} = '' or ${regiondirid} is null) or C.regiondirid = ${regiondirid}::bigint)
						</script>
                     </query>
                </queries>
			</band>
        </bands>
        <queries/>
    </rootBand>
</report>
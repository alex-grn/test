<?xml version="1.0" encoding="UTF-8"?>
<report name="report">
    <templates>
        <template code="DEFAULT" documentName="sheet_calculation_uik.xlsx" documentpath="sheet_calculation_uik.xlsx" outputtype="xlsx" outputnamepattern="sheet_calculation_uik.xlsx"/>
    </templates>
    <rootBand name="Root" orientation="H">
        <bands>
		    <band name="header" orientation="H">
				<queries>
                     <query name="header" type="sql">
                        <script>
							select reg.name as name_sub,
									--ik.name as name_ter,
									(select i.name from ELECTCOMMITTEE i where I.IDGASECOM = IK.IDGASPARECOM) as name_ter,
								c.officialname as name_cho,
								ik.ELECDISTNUMB as num_uch,
								case
								 when p_tools_dmonth_to_nmonth(c.begindate)-p_tools_dmonth_to_nmonth(c.enddate)!=0 then p_tools_dmonth_to_smonth(c.begindate)||'-'||p_tools_dmonth_to_smonth(c.enddate)
                                 ELSE p_tools_dmonth_to_smonth(c.begindate)
                                 end as month,
								to_char(electdate,'yy') as year
							from register r,
									ELECTCOMMINCAMP k,
								ELECTCAMPAIGN c,
								ELECTCOMMITTEE ik,
								REGIONSRF Reg
							where r.id = ${id}::bigint
							and k.id = r.electcommincampid
							and c.id = k.electcampaignid
							and ik.id = k.electcommitteeid
							and reg.id = ik.regionsrfid
								;
						</script>
                     </query>
                </queries>
			</band>
			<band name="spec" orientation="H">
				<queries>
                     <query name="spec" type="sql">
                        <script>
							  select row_number() over () as pp, tbl.fio,tbl.post,
									round(sum(comp1),2) as comp1,
                                    round(sum(comp2),2) as comp2,
									round(sum(days_worked1),2) as days_worked1,
                                    round(sum(days_worked2),2) as days_worked2,
									round(sum(compensation1),2) as compensation1,
                                    round(sum(compensation2),2) as compensation2,
									max(dop_ot) as dop_ot,
									max(r_coef) as r_coef,
									sum(week_days) as week_days,
									sum(night_days) as night_days,
									sum(dop_money) as dop_money,
									max(v_coef) as v_coef,
									sum(n_sum) as n_sum,
									postbegindate, postprint
								FROM(
								select  ch.id,
								  CH.postbegindate, p.postprint,
								  COALESCE(pp.surname,'')||' '||COALESCE(pp.firstname,'')||' '||COALESCE(pp.middlename,'') as fio,
								  case p.postprint when 'CHAIRMAN' then 'Председатель' when 'DEPCHAIRMAN' then 'Заместитель председателя' when 'SECRETARY' then 'Секретарь' when 'ZOTHERCM' then 'Член комиссии' end as post,
								   
								  (select ttb.norm from 
                                  (select row_number() over(order by wc.code) as nums, pp.norm from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  where ttb.nums = 1) as comp1,
                                  (select ttb.norm from 
                                  (select row_number() over(order by wc.code) as nums, pp.norm from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  where ttb.nums = 2) as comp2,
                                  
                                  (select ttb.workhours from 
                                  (select row_number() over(order by wc.code) as nums, pp.workhours from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  where ttb.nums = 1) as days_worked1,
                                  (select ttb.workhours from 
                                  (select row_number() over(order by wc.code) as nums, pp.workhours from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  where ttb.nums = 2) as days_worked2,
                                  
                                  (select ttb.sumpay from 
                                  (select row_number() over(order by wc.code) as nums, pp.sumpay from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  where ttb.nums = 1) as compensation1,
                                  (select ttb.sumpay from 
                                  (select row_number() over(order by wc.code) as nums, pp.sumpay from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  where ttb.nums = 2) as compensation2,
								  
								  COALESCE((select sum(COALESCE(pp.norm,0)) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRA1'),0) as dop_ot,
								  case ik.levelelcampaign
                                   when 'central' then (select t.discoefffed from ELECTCOMMITTEE t where t.id = i.electcommitteeid)
                                   when 'region' then (select t.discoefreg from ELECTCOMMITTEE t where t.id = i.electcommitteeid)
                                  end as r_coef,
								  COALESCE((select sum(COALESCE(pp.workhours,0)) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRA1'),0) as week_days,
								  COALESCE((select sum(COALESCE(pp.workhours,0)) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRA2'),0) as night_days,   
								  COALESCE((select sum(COALESCE(pp.sumpay,0)) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'SUMEXTRA12'),0) as dop_money,        
								  COALESCE(r.depcoeff,0) as v_coef,
								  COALESCE((select sum(COALESCE(pp.sumpay,0)) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRAA'),0) as n_sum		
							  from registerlist r,
								   COMMITTEEMAN ch,
								   person pp,
								   posts p,
								   register rr,
								   ELECTCAMPAIGN ik,
								   ELECTCOMMINCAMP i
							 where r.registerid = any(P_SYSTEM_GET_SELECTLIST(${idlist}::text))
							   and ch.id = r.committeemanid
							   and pp.id = ch.personid
							   and p.id = ch.postsid
							   and rr.id = r.registerid
							   and ik.id = rr.electcampaignid
							   and i.id = rr.electcommincampid
							   ORDER BY CH.postbegindate, p.postprint) tbl
                               group by tbl.id,tbl.fio,tbl.post,tbl.postbegindate, tbl.postprint
							   order by tbl.postbegindate, tbl.postprint;
   							   
						</script>
                     </query>
                </queries>
			</band>
			<band name="floor" orientation="H">
				<queries>
                     <query name="floor" type="sql">
                        <script>
							select round(sum(tbl.compensation1),2) as sum_compensation1,
									round(sum(tbl.compensation2),2) as sum_compensation2,
									sum(tbl.week_days) as sum_week_days,
									sum(tbl.night_days) as sum_night_days,
									sum(tbl.dop_money) as sum_dop_money,
									sum(tbl.n_sum) as sum_sum,
                                    sum(tbl.sum_dop) as sum_dop,
									(SELECT S.NAME FROM PERSON S WHERE S.ID = ${supervisor}::bigint) as ruk, 
									(SELECT S.NAME FROM PERSON S WHERE S.ID = ${accountant}::bigint) as buh
								from (
									select  
									(select ttb.sumpay from 
                                  	(select row_number() over(order by wc.code) as nums, pp.sumpay from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  	where ttb.nums = 1) as compensation1,
                                  	(select ttb.sumpay from 
                                  	(select row_number() over(order by wc.code) as nums, pp.sumpay from pays pp, slcompcharges s, workcalendars wc where pp.registerlistid = r.id and s.id = pp.slcompchargesid and wc.id = pp.workcalendarsid and s.description = 'COMPENSATION' order by wc.code) ttb
                                  	where ttb.nums = 2) as compensation2,
                                        
										COALESCE((select sum(pp.workhours) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRA1'),0) as week_days,
										COALESCE((select sum(pp.workhours) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRA2'),0) as night_days,   
										COALESCE((select sum(pp.sumpay) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'SUMEXTRA12'),0) as dop_money, 
										COALESCE((select sum(pp.sumpay) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRAA'),0) as n_sum,
                                        /*COALESCE(r.depcoeff,0) *
								  COALESCE((select sum(COALESCE(pp.sumpay,0)) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRAA'),0) as sum_dop*/
										COALESCE((select sum(pp.sumpay) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'SUMEXTRA12'),0) + 
										COALESCE((select sum(pp.sumpay) from pays pp, slcompcharges s where pp.registerlistid = r.id and s.id = pp.slcompchargesid and s.description = 'EXTRAA'),0) as sum_dop
										
								from registerlist r,
										COMMITTEEMAN ch,
										posts p
								where r.registerid = any(P_SYSTEM_GET_SELECTLIST(${idlist}::text))
									and ch.id = r.committeemanid
									and p.id = ch.postsid) tbl
   							   ;
						</script>
                     </query>
                </queries>
			</band>
        </bands>
        <queries/>
    </rootBand>
</report>